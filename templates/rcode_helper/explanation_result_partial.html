<div class="result-section">
    <!-- ç»“æœæ ‡é¢˜ -->
    <div class="result-title-section">
        <h3 class="result-main-title">
            <i class="fas fa-lightbulb me-2" aria-hidden="true">ğŸ’¡</i>
            ä»£ç è§£é‡Šç»“æœ
        </h3>
        <p class="result-subtitle">AIä¸ºæ‚¨è¯¦ç»†è§£æRè¯­è¨€ä»£ç çš„å«ä¹‰å’Œç”¨æ³•</p>
    </div>
    
    <!-- ç”¨æˆ·æŸ¥è¯¢ä¿¡æ¯æ˜¾ç¤º -->
    {% if user_query %}
    <div class="info-card query-info-card">
        <div class="info-header">
            <div class="info-icon query-icon">
                <i class="fas fa-question-circle" aria-hidden="true">â“</i>
            </div>
            <div class="info-content">
                <h6 class="info-title">æ‚¨çš„å…·ä½“é—®é¢˜</h6>
                <p class="info-text">{{ user_query }}</p>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- é€‰ä¸­è¡Œä¿¡æ¯æ˜¾ç¤º -->
    {% if selected_lines %}
    <div class="info-card selected-lines-card">
        <div class="info-header">
            <div class="info-icon highlight-icon">
                <i class="fas fa-highlighter" aria-hidden="true">ğŸ“</i>
            </div>
            <div class="info-content">
                <h6 class="info-title">é‡ç‚¹å…³æ³¨çš„ä»£ç è¡Œ</h6>
                <p class="info-text">ç¬¬ {{ selected_lines|join:", " }} è¡Œ</p>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- ä¸»è¦ç»“æœå¡ç‰‡ -->
    <div class="main-result-card">
        <!-- å¡ç‰‡å¤´éƒ¨ -->
        <div class="card-header-section">
            <div class="header-icon">
                <i class="fas fa-file-code" aria-hidden="true">ğŸ“„</i>
            </div>
            <div class="header-content">
                <h4 class="card-title">ä»£ç åˆ†æç»“æœ</h4>
                <p class="card-subtitle">å®Œæ•´çš„ä»£ç è§£é‡Šå’Œè¯´æ˜</p>
            </div>
        </div>
        
        <!-- ä»£ç å±•ç¤ºåŒºåŸŸ -->
        <div class="code-display-section">
            <div class="section-header">
                <i class="fas fa-code me-2" aria-hidden="true">ğŸ’»</i>
                <span>åŸå§‹ä»£ç </span>
                {% if selected_lines %}
                <span class="highlight-badge">å·²é«˜äº®æ˜¾ç¤ºå…³æ³¨è¡Œ</span>
                {% endif %}
            </div>
            
            <div class="enhanced-code-container">
                <div class="line-numbers-panel" id="result-line-numbers">
                    <!-- è¡Œå·å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
                <div class="code-display-panel">
                    <pre class="code-block"><code class="language-r" id="result-code-content">{{ r_code }}</code></pre>
                </div>
            </div>
        </div>
        
        <!-- è§£é‡Šå†…å®¹åŒºåŸŸ -->
        <div class="explanation-display-section">
            <div class="section-header">
                <i class="fas fa-brain me-2" aria-hidden="true">ğŸ§ </i>
                <span>AIè¯¦ç»†è§£é‡Š</span>
            </div>
            
            <div class="explanation-content-wrapper">
                <div class="explanation-text">
                    {{ explanation|linebreaks }}
                </div>
            </div>
        </div>
    </div>
    
    <!-- é¡µè„šä¿¡æ¯ -->
    <div class="result-footer">
        <div class="footer-actions">
            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="window.print()">
                <i class="fas fa-print me-1" aria-hidden="true">ğŸ–¨ï¸</i>æ‰“å°ç»“æœ
            </button>
            <button type="button" class="btn btn-outline-primary btn-sm" onclick="copyToClipboard()">
                <i class="fas fa-copy me-1" aria-hidden="true">ğŸ“‹</i>å¤åˆ¶è§£é‡Š
            </button>
        </div>
        <div class="footer-info">
            <small class="text-muted">
                <i class="fas fa-clock me-1" aria-hidden="true">ğŸ•</i>
                è§£é‡Šå®Œæˆæ—¶é—´ï¼š{{ request.session.created_at|default:"åˆšåˆš" }}
            </small>
        </div>
    </div>
</div>

<style>
/* ä¸»è¦å®¹å™¨æ ·å¼ */
.result-section {
    max-width: 100%;
    margin: 0 auto;
    padding: 20px;
}

/* æ ‡é¢˜åŒºåŸŸ */
.result-title-section {
    text-align: center;
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 2px solid rgba(255, 105, 180, 0.2);
}

.result-main-title {
    font-size: 28px;
    font-weight: 700;
    color: var(--primary-color, #ff1493);
    margin-bottom: 10px;
    background: linear-gradient(135deg, #ff69b4, #ff1493);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.result-subtitle {
    font-size: 16px;
    color: #666;
    margin: 0;
}

/* ä¿¡æ¯å¡ç‰‡é€šç”¨æ ·å¼ */
.info-card {
    margin-bottom: 20px;
    border-radius: 15px;
    padding: 0;
    overflow: hidden;
    border: 1px solid rgba(255, 105, 180, 0.2);
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    transition: all 0.3s ease;
}

.info-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(255, 105, 180, 0.15);
}

.info-header {
    display: flex;
    align-items: center;
    padding: 15px 20px;
}

.info-icon {
    width: 45px;
    height: 45px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 15px;
    font-size: 18px;
    color: white;
}

.query-icon {
    background: linear-gradient(135deg, #3498db, #2980b9);
}

.highlight-icon {
    background: linear-gradient(135deg, #f39c12, #e67e22);
}

.info-content {
    flex: 1;
}

.info-title {
    font-size: 16px;
    font-weight: 600;
    margin: 0 0 5px 0;
    color: #333;
}

.info-text {
    margin: 0;
    color: #666;
    font-size: 14px;
    line-height: 1.5;
}

/* ä¸»ç»“æœå¡ç‰‡ */
.main-result-card {
    background: rgba(255, 255, 255, 0.95);
    border: 1px solid rgba(255, 105, 180, 0.2);
    border-radius: 20px;
    padding: 30px;
    margin-bottom: 25px;
    backdrop-filter: blur(10px);
    transition: all 0.3s ease;
}

.main-result-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 15px 40px rgba(255, 105, 180, 0.2);
}

/* å¡ç‰‡å¤´éƒ¨ */
.card-header-section {
    display: flex;
    align-items: center;
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 2px solid rgba(255, 105, 180, 0.15);
}

.header-icon {
    width: 60px;
    height: 60px;
    background: linear-gradient(135deg, #ff69b4, #ff1493);
    border-radius: 15px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    margin-right: 20px;
    font-size: 24px;
    box-shadow: 0 8px 20px rgba(255, 105, 180, 0.3);
}

.header-content {
    flex: 1;
}

.card-title {
    font-size: 22px;
    font-weight: 700;
    color: var(--primary-color, #ff1493);
    margin: 0 0 5px 0;
}

.card-subtitle {
    color: #666;
    margin: 0;
    font-size: 14px;
}

/* éƒ¨åˆ†æ ‡é¢˜ */
.section-header {
    display: flex;
    align-items: center;
    font-size: 18px;
    font-weight: 600;
    color: var(--primary-color, #ff1493);
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 1px solid rgba(255, 105, 180, 0.2);
}

.highlight-badge {
    margin-left: auto;
    background: linear-gradient(135deg, #f39c12, #e67e22);
    color: white;
    padding: 4px 12px;
    border-radius: 15px;
    font-size: 12px;
    font-weight: 500;
}

/* å¢å¼ºçš„ä»£ç å®¹å™¨ */
.enhanced-code-container {
    display: flex;
    background: #f8f9fa;
    border: 1px solid rgba(255, 105, 180, 0.2);
    border-radius: 12px;
    overflow: hidden;
    margin-bottom: 30px;
}

.line-numbers-panel {
    width: 60px;
    background: rgba(255, 105, 180, 0.05);
    border-right: 1px solid rgba(255, 105, 180, 0.2);
    padding: 20px 10px;
    font-family: 'Fira Code', 'Courier New', monospace;
    font-size: 13px;
    line-height: 1.6;
    color: #999;
    text-align: right;
    user-select: none;
}

.line-number {
    display: block;
    padding: 0 5px;
    border-radius: 3px;
    transition: all 0.2s ease;
}

.line-number.highlighted {
    background: linear-gradient(135deg, rgba(243, 156, 18, 0.3), rgba(230, 126, 34, 0.3));
    color: #f39c12;
    font-weight: bold;
    border: 1px solid rgba(243, 156, 18, 0.4);
}

.code-display-panel {
    flex: 1;
}

.code-block {
    margin: 0;
    padding: 20px;
    background: transparent;
    border: none;
    overflow-x: auto;
    font-family: 'Fira Code', 'Courier New', monospace;
    font-size: 14px;
    line-height: 1.6;
    color: #333;
}

.code-block code {
    background: transparent;
    padding: 0;
}

/* è§£é‡Šå†…å®¹åŒºåŸŸ */
.explanation-content-wrapper {
    background: linear-gradient(135deg, rgba(255, 192, 203, 0.1), rgba(255, 182, 193, 0.1));
    border: 1px solid rgba(255, 105, 180, 0.2);
    border-radius: 12px;
    padding: 25px;
    border-left: 4px solid var(--primary-color, #ff69b4);
}

.explanation-text {
    font-size: 15px;
    line-height: 1.8;
    color: #555;
    margin: 0;
}

.explanation-text p:last-child {
    margin-bottom: 0;
}

/* é¡µè„š */
.result-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 30px;
    padding-top: 20px;
    border-top: 1px solid rgba(255, 105, 180, 0.2);
}

.footer-actions {
    display: flex;
    gap: 10px;
}

.footer-actions .btn {
    border-radius: 20px;
    padding: 8px 16px;
    font-size: 13px;
    transition: all 0.3s ease;
}

.footer-actions .btn:hover {
    transform: translateY(-1px);
}

.footer-info {
    color: #999;
    font-size: 13px;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
    .result-section {
        padding: 15px;
    }
    
    .main-result-card {
        padding: 20px;
    }
    
    .card-header-section {
        flex-direction: column;
        text-align: center;
    }
    
    .header-icon {
        margin-right: 0;
        margin-bottom: 15px;
    }
    
    .enhanced-code-container {
        flex-direction: column;
    }
    
    .line-numbers-panel {
        width: 100%;
        padding: 10px;
        text-align: center;
        border-right: none;
        border-bottom: 1px solid rgba(255, 105, 180, 0.2);
    }
    
    .line-number {
        display: inline-block;
        margin: 0 2px;
    }
    
    .result-footer {
        flex-direction: column;
        gap: 15px;
        text-align: center;
    }
    
    .footer-actions {
        justify-content: center;
    }
}

/* æ‰“å°æ ·å¼ */
@media print {
    .footer-actions {
        display: none;
    }
    
    .main-result-card {
        box-shadow: none;
        border: 1px solid #ddd;
    }
    
    .result-main-title {
        color: #333 !important;
        -webkit-text-fill-color: #333 !important;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // ç”Ÿæˆè¡Œå·å’Œé«˜äº®æ˜¾ç¤º
    const codeContent = document.getElementById('result-code-content');
    const lineNumbersContainer = document.getElementById('result-line-numbers');
    
    if (codeContent && lineNumbersContainer) {
        const codeText = codeContent.textContent;
        const lines = codeText.split('\n');
        // ä»æ¨¡æ¿è·å–é€‰ä¸­çš„è¡Œæ•°æ®
        const selectedLinesData = document.querySelector('[data-selected-lines]');
        let selectedLines = [];
        
        if (selectedLinesData) {
            try {
                selectedLines = JSON.parse(selectedLinesData.getAttribute('data-selected-lines'));
            } catch (e) {
                selectedLines = [];
            }
        }
        
        let lineNumbersHtml = '';
        for (let i = 1; i <= lines.length; i++) {
            const isHighlighted = selectedLines.includes(i);
            lineNumbersHtml += `<span class="line-number ${isHighlighted ? 'highlighted' : ''}" title="ç¬¬ ${i} è¡Œ">${i}</span>`;
        }
        
        lineNumbersContainer.innerHTML = lineNumbersHtml;
    }
    
    // å¦‚æœå­˜åœ¨Prism.jsï¼Œè¿›è¡Œè¯­æ³•é«˜äº®
    if (typeof Prism !== 'undefined') {
        Prism.highlightAll();
    }
    
    // ç»“æœå¡ç‰‡å…¥åœºåŠ¨ç”»
    const animationElements = document.querySelectorAll('.info-card, .main-result-card');
    animationElements.forEach((element, index) => {
        element.style.opacity = '0';
        element.style.transform = 'translateY(30px)';
        
        setTimeout(() => {
            element.style.transition = 'all 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
            element.style.opacity = '1';
            element.style.transform = 'translateY(0)';
        }, index * 150);
    });
    
    // é¡µé¢æ ‡é¢˜åŠ¨ç”»
    const titleElement = document.querySelector('.result-main-title');
    if (titleElement) {
        titleElement.style.opacity = '0';
        titleElement.style.transform = 'scale(0.9)';
        
        setTimeout(() => {
            titleElement.style.transition = 'all 0.6s ease';
            titleElement.style.opacity = '1';
            titleElement.style.transform = 'scale(1)';
        }, 100);
    }
});

// å¤åˆ¶è§£é‡Šå†…å®¹åˆ°å‰ªè´´æ¿
function copyToClipboard() {
    const explanationText = document.querySelector('.explanation-text');
    if (explanationText) {
        const text = explanationText.textContent || explanationText.innerText;
        
        if (navigator.clipboard && window.isSecureContext) {
            navigator.clipboard.writeText(text).then(() => {
                showNotification('è§£é‡Šå†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼', 'success');
            }).catch(() => {
                fallbackCopyTextToClipboard(text);
            });
        } else {
            fallbackCopyTextToClipboard(text);
        }
    }
}

// å¤‡ç”¨å¤åˆ¶æ–¹æ³•
function fallbackCopyTextToClipboard(text) {
    const textArea = document.createElement("textarea");
    textArea.value = text;
    textArea.style.top = "0";
    textArea.style.left = "0";
    textArea.style.position = "fixed";

    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();

    try {
        const successful = document.execCommand('copy');
        if (successful) {
            showNotification('è§£é‡Šå†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼', 'success');
        } else {
            showNotification('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©å¹¶å¤åˆ¶', 'error');
        }
    } catch (err) {
        showNotification('å¤åˆ¶åŠŸèƒ½ä¸å¯ç”¨', 'error');
    }

    document.body.removeChild(textArea);
}

// é€šçŸ¥æç¤ºå‡½æ•°
function showNotification(message, type = 'info') {
    // ç§»é™¤å·²å­˜åœ¨çš„é€šçŸ¥
    const existingNotification = document.querySelector('.custom-notification');
    if (existingNotification) {
        existingNotification.remove();
    }
    
    // åˆ›å»ºé€šçŸ¥å…ƒç´ 
    const notification = document.createElement('div');
    notification.className = `custom-notification notification-${type}`;
    notification.innerHTML = `
        <div class="notification-content">
            <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
            <span>${message}</span>
        </div>
    `;
    
    // æ·»åŠ æ ·å¼
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        padding: 12px 20px;
        border-radius: 8px;
        color: white;
        font-size: 14px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        transform: translateX(100%);
        ${type === 'success' ? 'background: linear-gradient(135deg, #27ae60, #2ecc71);' : 
          type === 'error' ? 'background: linear-gradient(135deg, #e74c3c, #c0392b);' : 
          'background: linear-gradient(135deg, #3498db, #2980b9);'}
    `;
    
    document.body.appendChild(notification);
    
    // æ˜¾ç¤ºåŠ¨ç”»
    setTimeout(() => {
        notification.style.transform = 'translateX(0)';
    }, 100);
    
    // è‡ªåŠ¨éšè—
    setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 3000);
}

// æ»šåŠ¨åˆ°ç‰¹å®šè¡Œå·
function scrollToLine(lineNumber) {
    const lineElement = document.querySelector(`.line-number:nth-child(${lineNumber})`);
    if (lineElement) {
        lineElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
        
        // ä¸´æ—¶é«˜äº®æ•ˆæœ
        lineElement.style.background = 'rgba(255, 193, 7, 0.5)';
        setTimeout(() => {
            lineElement.style.background = '';
        }, 2000);
    }
}
</script>

<!-- éšè—çš„æ•°æ®å®¹å™¨ï¼Œç”¨äºä¼ é€’é€‰ä¸­è¡Œä¿¡æ¯ç»™JavaScript -->
{% if selected_lines %}
<div data-selected-lines="{{ selected_lines|safe }}" style="display: none;"></div>
{% endif %}