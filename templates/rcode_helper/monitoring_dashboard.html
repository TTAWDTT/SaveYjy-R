{% extends 'rcode_helper/base.html' %}

{% block title %}系统监控仪表板 - R语言助手{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="display-6 mb-0">
                    <i class="fas fa-chart-line me-3 text-primary"></i>
                    系统监控仪表板
                </h1>
                <div class="btn-group" role="group">
                    <button class="btn btn-outline-primary" onclick="refreshDashboard()">
                        <i class="fas fa-sync-alt me-2"></i>刷新数据
                    </button>
                    <button class="btn btn-outline-success" onclick="exportReport()">
                        <i class="fas fa-download me-2"></i>导出报告
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 系统健康状态卡片 -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card bg-gradient-primary text-white h-100">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-uppercase mb-1">系统可用性</div>
                            <div class="h5 mb-0 font-weight-bold" id="uptime-percentage">--</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-heartbeat fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card bg-gradient-success text-white h-100">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-uppercase mb-1">总请求数</div>
                            <div class="h5 mb-0 font-weight-bold" id="total-requests">--</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-server fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card bg-gradient-warning text-white h-100">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-uppercase mb-1">错误率</div>
                            <div class="h5 mb-0 font-weight-bold" id="error-rate">--</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-exclamation-triangle fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card bg-gradient-info text-white h-100">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-uppercase mb-1">平均响应时间</div>
                            <div class="h5 mb-0 font-weight-bold" id="avg-response-time">--</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-clock fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 性能图表 -->
    <div class="row mb-4">
        <div class="col-lg-8">
            <div class="card h-100">
                <div class="card-header">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-chart-area me-2"></i>操作性能趋势
                    </h6>
                </div>
                <div class="card-body">
                    <canvas id="performanceChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="card h-100">
                <div class="card-header">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-chart-pie me-2"></i>操作类型分布
                    </h6>
                </div>
                <div class="card-body">
                    <canvas id="operationChart" width="200" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 操作统计表格 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-table me-2"></i>操作详细统计
                    </h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered table-striped">
                            <thead>
                                <tr>
                                    <th>操作类型</th>
                                    <th>请求次数</th>
                                    <th>平均时间 (ms)</th>
                                    <th>成功率</th>
                                    <th>状态</th>
                                </tr>
                            </thead>
                            <tbody id="operation-stats-table">
                                <tr>
                                    <td colspan="5" class="text-center text-muted">加载中...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 用户行为分析 -->
    <div class="row mb-4">
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-users me-2"></i>用户行为分析
                    </h6>
                </div>
                <div class="card-body">
                    <canvas id="userAnalyticsChart" width="400" height="300"></canvas>
                </div>
            </div>
        </div>
        
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-cogs me-2"></i>系统资源使用
                    </h6>
                </div>
                <div class="card-body">
                    <div id="system-resources">
                        <div class="mb-3">
                            <label class="form-label">缓存命中率</label>
                            <div class="progress">
                                <div id="cache-hit-rate" class="progress-bar bg-success" style="width: 0%">0%</div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">API响应质量</label>
                            <div class="progress">
                                <div id="api-quality" class="progress-bar bg-info" style="width: 0%">0%</div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">用户满意度</label>
                            <div class="progress">
                                <div id="user-satisfaction" class="progress-bar bg-warning" style="width: 0%">0%</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 错误日志 -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h6 class="m-0 font-weight-bold text-danger">
                        <i class="fas fa-exclamation-circle me-2"></i>最近错误日志
                    </h6>
                </div>
                <div class="card-body">
                    <div id="error-logs" style="max-height: 300px; overflow-y: auto;">
                        <p class="text-muted text-center">暂无错误记录</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 浮动操作按钮 -->
<button class="floating-action-button" onclick="toggleRealTimeMode()" title="切换实时监控">
    <i class="fas fa-play" id="realtime-icon"></i>
</button>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
class MonitoringDashboard {
    constructor() {
        this.charts = {};
        this.realTimeMode = false;
        this.refreshInterval = null;
        this.init();
    }
    
    init() {
        this.initCharts();
        this.loadDashboardData();
        this.setupEventListeners();
    }
    
    initCharts() {
        // 性能趋势图
        const performanceCtx = document.getElementById('performanceChart').getContext('2d');
        this.charts.performance = new Chart(performanceCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: '平均响应时间 (ms)',
                    data: [],
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
        
        // 操作类型分布图
        const operationCtx = document.getElementById('operationChart').getContext('2d');
        this.charts.operation = new Chart(operationCtx, {
            type: 'doughnut',
            data: {
                labels: [],
                datasets: [{
                    data: [],
                    backgroundColor: [
                        '#FF6384',
                        '#36A2EB',
                        '#FFCE56',
                        '#4BC0C0',
                        '#9966FF',
                        '#FF9F40'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });
        
        // 用户行为分析图
        const userCtx = document.getElementById('userAnalyticsChart').getContext('2d');
        this.charts.userAnalytics = new Chart(userCtx, {
            type: 'bar',
            data: {
                labels: [],
                datasets: [{
                    label: '操作次数',
                    data: [],
                    backgroundColor: 'rgba(54, 162, 235, 0.8)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
    
    async loadDashboardData() {
        try {
            progressMonitor.showNotification('正在加载监控数据...', 'info', 2000);
            
            const response = await fetch('/api/performance-dashboard/');
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            
            const data = await response.json();
            this.updateDashboard(data.data);
            
            progressMonitor.showNotification('监控数据加载完成', 'success', 2000);
            
        } catch (error) {
            console.error('Dashboard data loading error:', error);
            progressMonitor.showNotification('加载监控数据失败', 'danger');
        }
    }
    
    updateDashboard(data) {
        // 更新系统健康状态
        document.getElementById('uptime-percentage').textContent = 
            `${data.system_health.uptime_percentage.toFixed(1)}%`;
        document.getElementById('total-requests').textContent = 
            data.system_health.total_requests;
        document.getElementById('error-rate').textContent = 
            `${data.system_health.error_rate.toFixed(1)}%`;
        
        // 计算平均响应时间
        const avgResponseTime = Object.values(data.operation_stats)
            .reduce((sum, stat) => sum + stat.avg_time, 0) / 
            Object.keys(data.operation_stats).length;
        document.getElementById('avg-response-time').textContent = 
            `${(avgResponseTime * 1000).toFixed(0)}ms`;
        
        // 更新操作统计表格
        this.updateOperationStatsTable(data.operation_stats);
        
        // 更新图表
        this.updateCharts(data);
        
        // 更新系统资源使用
        this.updateSystemResources(data);
    }
    
    updateOperationStatsTable(operationStats) {
        const tbody = document.getElementById('operation-stats-table');
        tbody.innerHTML = '';
        
        Object.entries(operationStats).forEach(([operation, stats]) => {
            const row = document.createElement('tr');
            
            const statusClass = stats.success_rate >= 95 ? 'success' : 
                               stats.success_rate >= 80 ? 'warning' : 'danger';
            const statusIcon = stats.success_rate >= 95 ? 'check-circle' : 
                              stats.success_rate >= 80 ? 'exclamation-triangle' : 'times-circle';
            
            row.innerHTML = `
                <td><strong>${operation}</strong></td>
                <td>${stats.count}</td>
                <td>${(stats.avg_time * 1000).toFixed(0)}</td>
                <td>
                    <div class="progress" style="height: 20px;">
                        <div class="progress-bar bg-${statusClass}" 
                             style="width: ${stats.success_rate}%">
                            ${stats.success_rate.toFixed(1)}%
                        </div>
                    </div>
                </td>
                <td>
                    <span class="badge bg-${statusClass}">
                        <i class="fas fa-${statusIcon} me-1"></i>
                        ${stats.success_rate >= 95 ? '优秀' : stats.success_rate >= 80 ? '良好' : '需要关注'}
                    </span>
                </td>
            `;
            
            tbody.appendChild(row);
        });
    }
    
    updateCharts(data) {
        // 更新操作类型分布图
        const operationLabels = Object.keys(data.operation_stats);
        const operationData = Object.values(data.operation_stats).map(stat => stat.count);
        
        this.charts.operation.data.labels = operationLabels;
        this.charts.operation.data.datasets[0].data = operationData;
        this.charts.operation.update();
        
        // 更新用户行为分析图
        const userLabels = Object.keys(data.user_analytics);
        const userData = Object.values(data.user_analytics);
        
        this.charts.userAnalytics.data.labels = userLabels;
        this.charts.userAnalytics.data.datasets[0].data = userData;
        this.charts.userAnalytics.update();
        
        // 更新性能趋势图（模拟数据）
        const now = new Date();
        const timeLabels = [];
        const performanceData = [];
        
        for (let i = 23; i >= 0; i--) {
            const time = new Date(now.getTime() - i * 60 * 60 * 1000);
            timeLabels.push(time.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' }));
            performanceData.push(Math.random() * 1000 + 200); // 模拟响应时间
        }
        
        this.charts.performance.data.labels = timeLabels;
        this.charts.performance.data.datasets[0].data = performanceData;
        this.charts.performance.update();
    }
    
    updateSystemResources(data) {
        // 模拟系统资源数据
        const cacheHitRate = Math.random() * 30 + 70; // 70-100%
        const apiQuality = Math.random() * 20 + 80;   // 80-100%
        const userSatisfaction = Math.random() * 25 + 75; // 75-100%
        
        document.getElementById('cache-hit-rate').style.width = `${cacheHitRate}%`;
        document.getElementById('cache-hit-rate').textContent = `${cacheHitRate.toFixed(1)}%`;
        
        document.getElementById('api-quality').style.width = `${apiQuality}%`;
        document.getElementById('api-quality').textContent = `${apiQuality.toFixed(1)}%`;
        
        document.getElementById('user-satisfaction').style.width = `${userSatisfaction}%`;
        document.getElementById('user-satisfaction').textContent = `${userSatisfaction.toFixed(1)}%`;
    }
    
    setupEventListeners() {
        // 添加键盘快捷键
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'r') {
                e.preventDefault();
                this.loadDashboardData();
            }
        });
    }
    
    toggleRealTimeMode() {
        this.realTimeMode = !this.realTimeMode;
        const icon = document.getElementById('realtime-icon');
        
        if (this.realTimeMode) {
            icon.className = 'fas fa-pause';
            this.refreshInterval = setInterval(() => {
                this.loadDashboardData();
            }, 30000); // 每30秒刷新
            progressMonitor.showNotification('实时监控已启用', 'success');
        } else {
            icon.className = 'fas fa-play';
            if (this.refreshInterval) {
                clearInterval(this.refreshInterval);
            }
            progressMonitor.showNotification('实时监控已停用', 'info');
        }
    }
}

// 全局函数
function refreshDashboard() {
    dashboard.loadDashboardData();
}

function exportReport() {
    progressMonitor.showNotification('导出功能开发中...', 'info');
}

function toggleRealTimeMode() {
    dashboard.toggleRealTimeMode();
}

// 初始化仪表板
let dashboard;
document.addEventListener('DOMContentLoaded', () => {
    dashboard = new MonitoringDashboard();
});
</script>
{% endblock %}