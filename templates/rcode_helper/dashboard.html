<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R语言智能助手 - 主控面板</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    {% load static %}
    <!-- 使用模块化后的主题样式路径 -->
    <link href="{% static 'css/themes/themes.css' %}" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            /* 背景由主题系统控制 */
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* 主容器 */
        .main-container {
            display: flex;
            min-height: 100vh;
        }

        /* 左侧导航栏 */
        .sidebar {
            width: 280px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(255, 182, 193, 0.3);
            padding: 30px 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 5px 0 30px rgba(255, 105, 180, 0.15);
        }

        .sidebar-header {
            padding: 0 30px 30px;
            border-bottom: 1px solid rgba(255, 182, 193, 0.2);
            margin-bottom: 30px;
        }

        .sidebar-brand {
            display: flex;
            align-items: center;
            text-decoration: none;
            color: #ff1493;
            font-weight: 700;
            font-size: 20px;
        }

        .sidebar-brand i {
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, #ff69b4, #ff1493);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            margin-right: 15px;
            font-size: 20px;
        }

        .user-info {
            margin-top: 15px;
            padding: 15px;
            background: rgba(255, 182, 193, 0.1);
            border-radius: 15px;
            border: 1px solid rgba(255, 182, 193, 0.2);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #ff69b4, #ff1493);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            margin-right: 12px;
        }

        .user-details h6 {
            margin: 0;
            color: #ff1493;
            font-weight: 600;
            font-size: 14px;
        }

        .user-details p {
            margin: 0;
            color: #888;
            font-size: 12px;
        }

        /* 导航菜单 */
        .nav-menu {
            padding: 0 20px;
        }

        .nav-item {
            margin-bottom: 8px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            color: #666;
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .nav-link i {
            width: 22px;
            margin-right: 15px;
            text-align: center;
            font-size: 18px;
        }

        .nav-link:hover {
            color: #ff1493;
            background: rgba(255, 105, 180, 0.1);
            transform: translateX(5px);
        }

        .nav-link.active {
            background: linear-gradient(135deg, #ff69b4, #ff1493);
            color: white;
            box-shadow: 0 8px 25px rgba(255, 105, 180, 0.3);
        }

        .nav-link.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            width: 4px;
            height: 100%;
            background: rgba(255, 255, 255, 0.5);
        }

        /* 退出按钮 */
        .logout-section {
            position: absolute;
            bottom: 30px;
            left: 20px;
            right: 20px;
        }

        .logout-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 12px;
            background: rgba(220, 53, 69, 0.1);
            color: #dc3545;
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.3s ease;
            border: 1px solid rgba(220, 53, 69, 0.2);
        }

        .logout-btn:hover {
            background: #dc3545;
            color: white;
        }

        /* 主内容区域 */
        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 30px;
            position: relative;
        }

        /* 内容卡片 */
        .content-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 25px;
            padding: 40px;
            box-shadow: 
                0 20px 60px rgba(255, 105, 180, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.3);
            min-height: calc(100vh - 60px);
        }

        /* 页面标题 */
        .page-header {
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 2px solid rgba(255, 182, 193, 0.2);
        }

        .page-title {
            font-size: 32px;
            font-weight: 700;
            color: #ff1493;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }

        .page-title i {
            margin-right: 15px;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #ff69b4, #ff1493);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 22px;
        }

        .page-subtitle {
            color: #888;
            font-size: 16px;
            margin: 0;
        }

        /* 表单样式 */
        .form-section {
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-label {
            font-weight: 600;
            color: #ff1493;
            margin-bottom: 10px;
            font-size: 16px;
            display: flex;
            align-items: center;
        }

        .form-label i {
            margin-right: 8px;
        }

        .form-control {
            border: 2px solid rgba(255, 105, 180, 0.2);
            border-radius: 15px;
            padding: 15px 20px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.8);
        }

        .form-control:focus {
            border-color: #ff69b4;
            box-shadow: 0 0 0 0.2rem rgba(255, 105, 180, 0.25);
            background: rgba(255, 255, 255, 0.95);
        }

        /* 代码输入容器 */
        .code-input-container {
            position: relative;
            display: flex;
            align-items: stretch;
            background: #f8f9fa;
            border: 2px solid rgba(255, 105, 180, 0.2);
            border-radius: 8px;
            overflow: hidden;
        }

        .code-input-container .form-control {
            font-family: 'Courier New', monospace;
            line-height: 1.6;
            resize: vertical;
            padding: 15px 15px 15px 50px;
            background: transparent;
            border: none;
            outline: none;
            flex: 1;
            min-height: 200px;
        }

        /* 行号显示 */
        .code-line-numbers {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 45px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            color: #6c757d;
            user-select: none;
            z-index: 10;
            pointer-events: none;
            background: rgba(248, 249, 250, 0.9);
            border-right: 1px solid rgba(255, 105, 180, 0.1);
            padding: 15px 8px 15px 0;
            overflow: hidden;
        }

        .line-numbers-content {
            transition: transform 0.1s ease-out;
            will-change: transform;
        }

        .line-number {
            display: block;
            padding: 0 8px;
            text-align: right;
            min-width: 30px;
            cursor: pointer;
            pointer-events: all;
            border-radius: 3px;
            transition: all 0.2s ease;
            height: 1.6em;
        }

        .line-number:hover {
            background: rgba(255, 105, 180, 0.1);
            color: #ff1493;
        }

        .line-number.selected {
            background: rgba(255, 105, 180, 0.3);
            color: #ff1493;
            font-weight: bold;
        }

        /* 选中行信息显示 */
        .selected-lines-info {
            margin-top: 10px;
            padding: 10px 15px;
            background: rgba(255, 105, 180, 0.1);
            border: 1px solid rgba(255, 105, 180, 0.3);
            border-radius: 8px;
            font-size: 14px;
            color: #ff1493;
        }

        /* 按钮样式 */
        .btn-pink {
            background: linear-gradient(135deg, #ff69b4, #ff1493);
            border: none;
            border-radius: 50px;
            padding: 15px 30px;
            font-weight: 600;
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(255, 105, 180, 0.3);
            position: relative;
            overflow: hidden;
        }

        .btn-pink::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }

        .btn-pink:hover::before {
            left: 100%;
        }

        .btn-pink:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(255, 105, 180, 0.4);
            color: white;
        }

        .btn-secondary {
            background: rgba(108, 117, 125, 0.1);
            border: 2px solid rgba(108, 117, 125, 0.2);
            color: #6c757d;
            border-radius: 50px;
            padding: 13px 28px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            background: #6c757d;
            border-color: #6c757d;
            color: white;
        }

        /* 加载状态 */
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 105, 180, 0.2);
            border-left: 4px solid #ff69b4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: #ff1493;
            font-weight: 600;
            font-size: 18px;
        }

        /* 结果显示 */
        .result-section {
            display: none;
            margin-top: 30px;
        }

        .result-card {
            background: rgba(255, 182, 193, 0.1);
            border: 1px solid rgba(255, 182, 193, 0.3);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 25px;
        }

        .result-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .result-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #ff69b4, #ff1493);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            margin-right: 15px;
        }

        .result-title {
            font-weight: 600;
            color: #ff1493;
            margin: 0;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .sidebar {
                width: 250px;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
                padding: 20px;
            }

            .content-card {
                padding: 25px;
            }

            .page-title {
                font-size: 24px;
            }
        }

        /* 隐藏类 */
        .d-none {
            display: none !important;
        }

        /* 粒子背景 */
        .particles-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
        }

        .particle {
            position: absolute;
            width: 6px;
            height: 6px;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 50%;
            animation: float 8s ease-in-out infinite;
        }

        .particle:nth-child(1) { top: 20%; left: 20%; animation-delay: 0s; }
        .particle:nth-child(2) { top: 60%; left: 80%; animation-delay: 2s; }
        .particle:nth-child(3) { top: 80%; left: 10%; animation-delay: 4s; }
        .particle:nth-child(4) { top: 40%; left: 70%; animation-delay: 1s; }
        .particle:nth-child(5) { top: 10%; left: 90%; animation-delay: 3s; }

        @keyframes float {
            0%, 100% { transform: translateY(0px); opacity: 0.7; }
            50% { transform: translateY(-20px); opacity: 1; }
        }

        /* ========== 文件上传样式 ========== */
        .input-method-selector {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 10px;
            border: 1px solid rgba(255, 182, 193, 0.3);
        }

        .input-method-selector .form-check {
            margin: 0;
        }

        .input-method-selector .form-check-label {
            font-weight: 500;
            color: #666;
            cursor: pointer;
            padding: 8px 16px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .input-method-selector .form-check-input:checked + .form-check-label {
            background: linear-gradient(135deg, #ff69b4, #ff1493);
            color: white;
            transform: translateY(-2px);
        }

        .file-upload-container {
            position: relative;
        }

        .file-drop-zone {
            border: 2px dashed #ff69b4;
            border-radius: 15px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
        }

        .file-drop-zone:hover {
            border-color: #ff1493;
            background: rgba(255, 105, 180, 0.1);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 105, 180, 0.2);
        }

        .file-drop-zone.dragover {
            border-color: #ff1493;
            background: rgba(255, 105, 180, 0.15);
            transform: scale(1.02);
        }

        .file-drop-content {
            pointer-events: none;
        }

        .file-preview {
            margin-top: 15px;
        }

        .file-info-card {
            display: flex;
            align-items: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            border: 1px solid rgba(255, 182, 193, 0.3);
            backdrop-filter: blur(10px);
        }

        .file-info-card i {
            color: #ff69b4;
            font-size: 18px;
        }

        #homework_file_input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        /* 文件上传动画 */
        .file-uploading {
            position: relative;
            overflow: hidden;
        }

        .file-uploading::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 105, 180, 0.3), transparent);
            animation: loading-sweep 2s infinite;
        }

        @keyframes loading-sweep {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        /* ========== 聊天界面样式 ========== */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 200px);
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 10px 40px rgba(255, 105, 180, 0.1);
            overflow: hidden;
        }

        /* 聊天头部 */
        .chat-header {
            padding: 20px 25px;
            background: linear-gradient(135deg, rgba(255, 105, 180, 0.1), rgba(255, 20, 147, 0.1));
            border-bottom: 1px solid rgba(255, 182, 193, 0.3);
        }

        .chat-header-content {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .ai-avatar {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #ff69b4, #ff1493);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            box-shadow: 0 4px 15px rgba(255, 105, 180, 0.3);
        }

        .chat-info {
            flex: 1;
        }

        .chat-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin: 0 0 5px 0;
        }

        .chat-status {
            margin: 0;
            font-size: 14px;
            color: #666;
            display: flex;
            align-items: center;
        }

        .chat-status.online {
            color: #28a745;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: #28a745;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* 消息区域 */
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            scroll-behavior: smooth;
        }

        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: rgba(255, 182, 193, 0.1);
            border-radius: 3px;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: rgba(255, 105, 180, 0.3);
            border-radius: 3px;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 105, 180, 0.5);
        }

        .message-group {
            margin-bottom: 20px;
        }

        .message {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            max-width: 85%;
        }

        .message.user-message {
            flex-direction: row-reverse;
            margin-left: auto;
        }

        .message.ai-message {
            margin-right: auto;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
        }

        .ai-message .message-avatar {
            background: linear-gradient(135deg, #ff69b4, #ff1493);
            color: white;
        }

        .user-message .message-avatar {
            background: linear-gradient(135deg, #6c757d, #495057);
            color: white;
        }

        .message-content {
            flex: 1;
        }

        .message-bubble {
            padding: 12px 16px;
            border-radius: 18px;
            position: relative;
            word-wrap: break-word;
        }

        .ai-message .message-bubble {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(255, 182, 193, 0.2);
            border-bottom-left-radius: 4px;
        }

        .user-message .message-bubble {
            background: linear-gradient(135deg, #ff69b4, #ff1493);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message-text {
            line-height: 1.5;
            font-size: 14px;
        }

        .message-time {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
            display: flex;
            align-items: center;
        }

        .user-message .message-time {
            justify-content: flex-end;
            color: rgba(255, 255, 255, 0.8);
        }

        .welcome-list {
            margin: 10px 0 0 0;
            padding-left: 20px;
        }

        .welcome-list li {
            margin-bottom: 5px;
            color: #666;
        }

        /* 打字指示器 */
        .typing-indicator .message-bubble {
            padding: 12px 20px;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .typing-dots span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ff69b4;
            animation: typing 1.4s infinite;
        }

        .typing-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: scale(1);
                opacity: 0.5;
            }
            30% {
                transform: scale(1.2);
                opacity: 1;
            }
        }

        /* 输入区域 */
        .chat-input-area {
            padding: 20px 25px;
            background: rgba(255, 255, 255, 0.7);
            border-top: 1px solid rgba(255, 182, 193, 0.3);
        }

        .input-container {
            position: relative;
        }

        .input-group {
            display: flex;
            align-items: flex-end;
            background: white;
            border-radius: 25px;
            border: 2px solid rgba(255, 182, 193, 0.3);
            padding: 8px 15px;
            transition: all 0.3s ease;
        }

        .input-group:focus-within {
            border-color: #ff69b4;
            box-shadow: 0 0 0 0.2rem rgba(255, 105, 180, 0.25);
        }

        .chat-input {
            border: none;
            outline: none;
            resize: none;
            flex: 1;
            min-height: 20px;
            max-height: 120px;
            font-size: 14px;
            line-height: 1.5;
            background: transparent;
        }

        .chat-input::placeholder {
            color: #999;
        }

        .input-actions {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-left: 10px;
        }

        .btn-ghost {
            background: none;
            border: none;
            color: #999;
            padding: 6px;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .btn-ghost:hover {
            background: rgba(255, 105, 180, 0.1);
            color: #ff69b4;
        }

        .btn-send {
            background: linear-gradient(135deg, #ff69b4, #ff1493);
            border: none;
            color: white;
            padding: 8px;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .btn-send:hover:not(:disabled) {
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(255, 105, 180, 0.4);
        }

        .btn-send:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .input-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
            padding: 0 5px;
        }

        /* 消息动画 */
        .message-group {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-bubble {
            transition: all 0.3s ease;
        }

        .message-bubble:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        /* 错误消息样式 */
        .message-bubble.error {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24) !important;
            color: white;
            border: 1px solid #ff4757;
        }

        /* 发送按钮动画 */
        .btn-send.sending {
            animation: pulse-send 0.6s ease-in-out infinite;
        }

        @keyframes pulse-send {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* 音符动画装饰 */
        .chat-container::before {
            content: '♪';
            position: absolute;
            top: 20px;
            right: 80px;
            font-size: 20px;
            color: rgba(255, 105, 180, 0.3);
            animation: float-note 3s ease-in-out infinite;
            z-index: 1;
        }

        @keyframes float-note {
            0%, 100% { transform: translateY(0px) rotate(0deg); opacity: 0.3; }
            50% { transform: translateY(-10px) rotate(5deg); opacity: 0.6; }
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .chat-container {
                height: calc(100vh - 150px);
                margin: 10px;
                border-radius: 15px;
            }

            .chat-header {
                padding: 15px 20px;
            }

            .chat-messages {
                padding: 15px;
            }

            .message {
                max-width: 95%;
            }

            .chat-input-area {
                padding: 15px 20px;
            }

            .ai-avatar {
                width: 40px;
                height: 40px;
                font-size: 18px;
            }

            .input-footer small {
                font-size: 11px;
            }

            .input-footer .ms-3 {
                display: none;
            }

            .chat-container::before {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- 粒子背景 -->
    <div class="particles-bg">
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
    </div>

    <div class="main-container">
        <!-- 左侧导航栏 -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <a href="#" class="sidebar-brand">
                    <i class="fas fa-chart-line"></i>
                    R语言智能助手
                </a>
                <div class="user-info d-flex align-items-center">
                    <div class="user-avatar">{{ username|first|upper }}</div>
                    <div class="user-details">
                        <h6>{{ username }}</h6>
                        <p>在线用户</p>
                    </div>
                </div>
            </div>

            <div class="nav-menu">
                <div class="nav-item">
                    <a href="#" class="nav-link active" data-section="homework">
                        <i class="fas fa-clipboard-list"></i>
                        <span>Answer - 作业解答</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="#" class="nav-link" data-section="explanation">
                        <i class="fas fa-code"></i>
                        <span>Explain - 代码解释</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="#" class="nav-link" data-section="chat">
                        <i class="fas fa-comments"></i>
                        <span>Talk - 智能对话</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="{% url 'rcode_helper:history' %}" class="nav-link">
                        <i class="fas fa-history"></i>
                        <span>历史记录</span>
                    </a>
                </div>
            </div>

            <div class="logout-section">
                <a href="{% url 'rcode_helper:logout' %}" class="logout-btn">
                    <i class="fas fa-sign-out-alt me-2"></i>
                    退出登录
                </a>
            </div>
        </nav>

        <!-- 主内容区域 -->
        <main class="main-content">
            <div class="content-card">
                <!-- 作业解答部分 -->
                <div id="homework-section" class="content-section">
                    <div class="page-header">
                        <h1 class="page-title">
                            <i class="fas fa-clipboard-list"></i>
                            作业题解答
                        </h1>
                        <p class="page-subtitle">输入R语言作业题，AI将为您生成三种不同的解决方案</p>
                    </div>

                    <form id="homework-form" class="form-section" enctype="multipart/form-data">
                        {% csrf_token %}
                        
                        <!-- 输入方式选择 -->
                        <div class="form-group mb-4">
                            <label class="form-label">
                                <i class="fas fa-cog"></i>
                                输入方式
                            </label>
                            <div class="input-method-selector">
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="input_method" id="input_text" value="text" checked onchange="toggleInputMethod()">
                                    <label class="form-check-label" for="input_text">
                                        <i class="fas fa-keyboard me-2"></i>文本输入
                                    </label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="input_method" id="input_file" value="file" onchange="toggleInputMethod()">
                                    <label class="form-check-label" for="input_file">
                                        <i class="fas fa-file-upload me-2"></i>文件上传
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 文本输入区域 -->
                        <div id="text-input-area" class="form-group">
                            <label for="{{ homework_form.homework_question.id_for_label }}" class="form-label">
                                <i class="fas fa-edit"></i>
                                {{ homework_form.homework_question.label }}
                            </label>
                            {{ homework_form.homework_question }}
                            <div class="form-text text-muted mt-2">{{ homework_form.homework_question.help_text }}</div>
                        </div>
                        
                        <!-- 文件上传区域 -->
                        <div id="file-input-area" class="form-group" style="display: none;">
                            <label for="{{ homework_form.homework_file.id_for_label }}" class="form-label">
                                <i class="fas fa-file-upload"></i>
                                {{ homework_form.homework_file.label }}
                            </label>
                            <div class="file-upload-container">
                                <div class="file-drop-zone" onclick="document.getElementById('{{ homework_form.homework_file.id_for_label }}').click()">
                                    <div class="file-drop-content">
                                        <i class="fas fa-cloud-upload-alt fa-3x mb-3 text-muted"></i>
                                        <p class="mb-2">点击选择文件或拖拽文件到此处</p>
                                        <p class="text-muted small">支持：.txt, .r, .R, .py, .md, .doc, .docx, .pdf</p>
                                        <p class="text-muted small">最大文件大小：10MB</p>
                                    </div>
                                </div>
                                {{ homework_form.homework_file }}
                            </div>
                            <div class="form-text text-muted mt-2">{{ homework_form.homework_file.help_text }}</div>
                            <div id="file-preview" class="file-preview mt-3" style="display: none;">
                                <div class="file-info-card">
                                    <i class="fas fa-file me-2"></i>
                                    <span id="file-name"></span>
                                    <span id="file-size" class="text-muted ms-2"></span>
                                    <button type="button" class="btn btn-sm btn-outline-danger ms-auto" onclick="clearFile()">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-flex gap-3">
                            <button type="submit" class="btn btn-pink">
                                <i class="fas fa-magic me-2"></i>生成解决方案
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="clearForm('homework-form')">
                                <i class="fas fa-eraser me-2"></i>清空
                            </button>
                        </div>
                    </form>

                    <div id="homework-loading" class="loading">
                        <div class="loading-spinner"></div>
                        <div class="loading-text">AI正在生成解决方案...</div>
                    </div>

                    <div id="homework-result" class="result-section"></div>
                </div>

                <!-- 代码解释部分 -->
                <div id="explanation-section" class="content-section d-none">
                    <div class="page-header">
                        <h1 class="page-title">
                            <i class="fas fa-code"></i>
                            代码解释
                        </h1>
                        <p class="page-subtitle">粘贴您的R语言代码，AI将用通俗易懂的语言为您解释</p>
                    </div>

                    <form id="explanation-form" class="form-section">
                        {% csrf_token %}
                        
                        <!-- 代码输入区域 -->
                        <div class="form-group">
                            <label for="{{ explanation_form.r_code.id_for_label }}" class="form-label">
                                <i class="fas fa-file-code"></i>
                                {{ explanation_form.r_code.label }}
                                <div class="float-end">
                                    <small class="text-muted">
                                        <span id="dashboard-line-count">0 行</span> | 
                                        <span id="dashboard-char-count">0 字符</span>
                                    </small>
                                </div>
                            </label>
                            <div class="advanced-code-input-container">
                                <!-- 高级代码编辑器 -->
                                <div id="dashboard-code-editor"></div>
                                <div class="code-editor-toolbar">
                                    <div class="toolbar-section">
                                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearDashboardEditor()">
                                            <i class="fas fa-trash me-1"></i>清空
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-info" onclick="toggleDashboardSymbolMode()">
                                            <i class="fas fa-font me-1"></i><span id="dashboard-symbol-text">符号</span>
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="formatDashboardCode()">
                                            <i class="fas fa-indent me-1"></i>格式化
                                        </button>
                                    </div>
                                    <div class="toolbar-section">
                                        <button type="button" class="btn btn-sm btn-outline-warning" onclick="toggleDashboardTheme()">
                                            <i class="fas fa-palette me-1"></i><span id="dashboard-theme-text">主题</span>
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-success" onclick="loadDashboardExample()">
                                            <i class="fas fa-code me-1"></i>示例
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- 隐藏的原始textarea -->
                                <textarea name="r_code" id="{{ explanation_form.r_code.id_for_label }}" style="display: none;" required></textarea>
                                
                                <div class="selected-lines-info" id="dashboard-selected-lines-info" style="display: none;">
                                    <div class="alert alert-info alert-sm mb-0">
                                        <i class="fas fa-highlight me-2"></i>
                                        已选择 <strong><span id="dashboard-selected-lines-display">0</span></strong> 行代码用于重点解释
                                        <button type="button" class="btn btn-sm btn-outline-info ms-2" onclick="clearDashboardLineSelection()">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="form-text text-muted mt-2">{{ explanation_form.r_code.help_text }}</div>
                        </div>

                        <!-- 用户查询输入 -->
                        <div class="form-group">
                            <label for="{{ explanation_form.user_query.id_for_label }}" class="form-label">
                                <i class="fas fa-question-circle"></i>
                                {{ explanation_form.user_query.label }}
                            </label>
                            {{ explanation_form.user_query }}
                            <div class="form-text text-muted mt-2">{{ explanation_form.user_query.help_text }}</div>
                        </div>

                        <!-- 隐藏字段存储选中的行号 -->
                        {{ explanation_form.selected_lines }}
                        
                        <div class="d-flex gap-3">
                            <button type="submit" class="btn btn-pink">
                                <i class="fas fa-lightbulb me-2"></i>解释代码
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="clearExplanationForm()">
                                <i class="fas fa-eraser me-2"></i>清空
                            </button>
                        </div>
                    </form>

                    <div id="explanation-loading" class="loading">
                        <div class="loading-spinner"></div>
                        <div class="loading-text">AI正在分析代码...</div>
                    </div>

                    <div id="explanation-result" class="result-section"></div>
                </div>

                <!-- 智能对话部分 -->
                <div id="chat-section" class="content-section d-none">
                    <div class="chat-container">
                        <!-- 聊天头部 -->
                        <div class="chat-header">
                            <div class="chat-header-content">
                                <div class="ai-avatar">
                                    <i class="fas fa-robot"></i>
                                </div>
                                <div class="chat-info">
                                    <h3 class="chat-title">R语言智能助手</h3>
                                    <p class="chat-status online">
                                        <span class="status-dot"></span>
                                        在线 - 随时为您解答问题
                                    </p>
                                </div>
                                <div class="chat-actions">
                                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="clearChatHistory()">
                                        <i class="fas fa-trash me-1"></i>清空对话
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- 聊天消息区域 -->
                        <div class="chat-messages" id="chat-messages">
                            <!-- 欢迎消息 -->
                            <div class="message-group">
                                <div class="message ai-message">
                                    <div class="message-avatar">
                                        <i class="fas fa-robot"></i>
                                    </div>
                                    <div class="message-content">
                                        <div class="message-bubble">
                                            <div class="message-text">
                                                👋 您好！我是R语言智能助手，很高兴为您服务！
                                                <br><br>
                                                我可以帮助您：
                                                <ul class="welcome-list">
                                                    <li>📊 解答R语言编程问题</li>
                                                    <li>📈 数据分析和可视化指导</li>
                                                    <li>🔍 统计学概念解释</li>
                                                    <li>🎯 学习建议和最佳实践</li>
                                                </ul>
                                                请随时向我提问，我会尽力为您提供专业的帮助！
                                            </div>
                                        </div>
                                        <div class="message-time">
                                            <i class="fas fa-clock me-1"></i>
                                            刚刚
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 打字指示器 -->
                        <div id="typing-indicator" class="typing-indicator" style="display: none;">
                            <div class="message-group">
                                <div class="message ai-message">
                                    <div class="message-avatar">
                                        <i class="fas fa-robot"></i>
                                    </div>
                                    <div class="message-content">
                                        <div class="message-bubble typing">
                                            <div class="typing-dots">
                                                <span></span>
                                                <span></span>
                                                <span></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 输入区域 -->
                        <div class="chat-input-area">
                            <form id="chat-form" class="chat-input-form">
                                {% csrf_token %}
                                <div class="input-container">
                                    <div class="input-group">
                                        <textarea 
                                            id="chat-message-input" 
                                            name="message"
                                            class="form-control chat-input" 
                                            placeholder="请输入您的问题..."
                                            rows="1"
                                            maxlength="1000"
                                            required></textarea>
                                        <div class="input-actions">
                                            <button type="button" class="btn btn-ghost" title="表情">
                                                <i class="fas fa-smile"></i>
                                            </button>
                                            <button type="submit" class="btn btn-send" disabled>
                                                <i class="fas fa-paper-plane"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="input-footer">
                                        <small class="text-muted">
                                            <span id="char-count">0</span>/1000 字符
                                            <span class="ms-3">按 Enter 发送，Shift + Enter 换行</span>
                                        </small>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-r.min.js"></script>
    
    <script>
        // SPA 导航逻辑
        document.addEventListener('DOMContentLoaded', function() {
            const navLinks = document.querySelectorAll('.nav-link[data-section]');
            const sections = document.querySelectorAll('.content-section');
            
            // 导航切换
            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    const targetSection = this.dataset.section;
                    
                    // 移除所有活动状态
                    navLinks.forEach(l => l.classList.remove('active'));
                    sections.forEach(s => s.classList.add('d-none'));
                    
                    // 添加活动状态
                    this.classList.add('active');
                    document.getElementById(targetSection + '-section').classList.remove('d-none');
                    
                    // 清除结果
                    clearResults();
                });
            });
            
            // 表单提交处理
            setupFormSubmissions();
        });
        
        // 表单提交设置
        function setupFormSubmissions() {
            // 设置文件上传功能
            setupFileUpload();
            
            // 设置聊天功能
            setupChatFeatures();
            
            // 设置代码行选择功能
            setupCodeLineSelection();
            
            // 作业题表单
            document.getElementById('homework-form').addEventListener('submit', function(e) {
                e.preventDefault();
                submitForm('homework', this);
            });
            
            // 代码解释表单
            document.getElementById('explanation-form').addEventListener('submit', function(e) {
                e.preventDefault();
                submitForm('explanation', this);
            });
            
            // 注意：聊天表单现在由setupChatFeatures()处理
        }
        
        // 通用表单提交
        function submitForm(type, form) {
            const formData = new FormData(form);
            const loadingElement = document.getElementById(type + '-loading');
            const resultElement = document.getElementById(type + '-result');
            
            // 显示加载状态
            loadingElement.style.display = 'block';
            resultElement.style.display = 'none';
            
            // 根据类型设置URL
            let url;
            switch(type) {
                case 'homework':
                    url = '{% url "rcode_helper:homework_solution" %}';
                    break;
                case 'explanation':
                    url = '{% url "rcode_helper:code_explanation" %}';
                    break;
                case 'chat':
                    url = '{% url "rcode_helper:chat" %}';
                    break;
            }
            
            // 提交请求
            fetch(url, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                if (response.redirected) {
                    // 如果重定向到结果页面，加载结果
                    return fetch(response.url).then(r => r.text());
                }
                return response.text();
            })
            .then(html => {
                // 隐藏加载状态
                loadingElement.style.display = 'none';
                
                // 显示结果
                resultElement.innerHTML = html;
                resultElement.style.display = 'block';
                
                // 高亮代码
                if (typeof Prism !== 'undefined') {
                    Prism.highlightAll();
                }
                
                // 滚动到结果
                resultElement.scrollIntoView({ behavior: 'smooth' });
            })
            .catch(error => {
                console.error('Error:', error);
                loadingElement.style.display = 'none';
                resultElement.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        请求失败，请稍后重试
                    </div>
                `;
                resultElement.style.display = 'block';
            });
        }
        
        // 清空表单
        function clearForm(formId) {
            const form = document.getElementById(formId);
            form.reset();
            
            // 清空对应的结果
            const type = formId.replace('-form', '');
            clearResult(type);
        }
        
        // 清空单个结果
        function clearResult(type) {
            const resultElement = document.getElementById(type + '-result');
            if (resultElement) {
                resultElement.innerHTML = '';
                resultElement.style.display = 'none';
            }
        }
        
        // 清空所有结果
        function clearResults() {
            ['homework', 'explanation', 'chat'].forEach(type => {
                clearResult(type);
                const loadingElement = document.getElementById(type + '-loading');
                if (loadingElement) {
                    loadingElement.style.display = 'none';
                }
            });
        }
        
        // 移动端菜单切换
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            sidebar.classList.toggle('active');
        }

        // ========== 文件上传功能 ==========

        // 设置文件上传功能
        function setupFileUpload() {
            const fileInput = document.getElementById('homework_file_input');
            const fileDropZone = document.querySelector('.file-drop-zone');
            const filePreview = document.getElementById('file-preview');

            if (!fileInput || !fileDropZone || !filePreview) {
                return; // 如果元素不存在，直接返回
            }

            // 文件选择事件
            fileInput.addEventListener('change', handleFileSelect);

            // 拖拽功能
            fileDropZone.addEventListener('dragover', handleDragOver);
            fileDropZone.addEventListener('dragenter', handleDragEnter);
            fileDropZone.addEventListener('dragleave', handleDragLeave);
            fileDropZone.addEventListener('drop', handleFileDrop);
        }

        // 输入方式切换
        function toggleInputMethod() {
            const textInput = document.getElementById('text-input-area');
            const fileInput = document.getElementById('file-input-area');
            const inputMethod = document.querySelector('input[name="input_method"]:checked').value;
            
            if (inputMethod === 'text') {
                textInput.style.display = 'block';
                fileInput.style.display = 'none';
                // 清空文件选择
                clearFile();
            } else {
                textInput.style.display = 'none';
                fileInput.style.display = 'block';
                // 清空文本输入
                document.getElementById('homework_text_input').value = '';
            }
        }

        // 处理文件选择
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                showFilePreview(file);
                validateFile(file);
            }
        }

        // 处理拖拽悬停
        function handleDragOver(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'copy';
        }

        // 处理拖拽进入
        function handleDragEnter(event) {
            event.preventDefault();
            event.target.closest('.file-drop-zone').classList.add('dragover');
        }

        // 处理拖拽离开
        function handleDragLeave(event) {
            event.preventDefault();
            const rect = event.target.getBoundingClientRect();
            const x = event.clientX;
            const y = event.clientY;
            
            // 只有当鼠标真正离开区域时才移除样式
            if (x < rect.left || x > rect.right || y < rect.top || y > rect.bottom) {
                event.target.closest('.file-drop-zone').classList.remove('dragover');
            }
        }

        // 处理文件拖拽放置
        function handleFileDrop(event) {
            event.preventDefault();
            event.target.classList.remove('dragover');
            
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                const fileInput = document.getElementById('homework_file_input');
                fileInput.files = files;
                
                // 触发change事件
                const changeEvent = new Event('change', { bubbles: true });
                fileInput.dispatchEvent(changeEvent);
            }
        }

        // 显示文件预览
        function showFilePreview(file) {
            const filePreview = document.getElementById('file-preview');
            const fileName = document.getElementById('file-name');
            const fileSize = document.getElementById('file-size');
            
            fileName.textContent = file.name;
            fileSize.textContent = `(${formatFileSize(file.size)})`;
            filePreview.style.display = 'block';
        }

        // 清空文件选择
        function clearFile() {
            const fileInput = document.getElementById('homework_file_input');
            const filePreview = document.getElementById('file-preview');
            
            if (fileInput) {
                fileInput.value = '';
            }
            if (filePreview) {
                filePreview.style.display = 'none';
            }
        }

        // 设置代码行选择功能
        let selectedLines = new Set();
        
        function setupCodeLineSelection() {
            const codeInput = document.getElementById('r_code_input');
            const lineNumbers = document.getElementById('code-line-numbers');
            const selectedLinesInfo = document.getElementById('selected-lines-info');
            const selectedLinesDisplay = document.getElementById('selected-lines-display');
            const selectedLinesInput = document.getElementById('selected_lines_input');
            
            if (!codeInput || !lineNumbers) {
                return;
            }
            
            // 监听代码输入变化
            codeInput.addEventListener('input', updateLineNumbers);
            
            // 添加滚动监听器，使用 requestAnimationFrame 来优化性能
            let scrollTicking = false;
            codeInput.addEventListener('scroll', function() {
                if (!scrollTicking) {
                    requestAnimationFrame(function() {
                        syncLineNumbersScroll();
                        scrollTicking = false;
                    });
                    scrollTicking = true;
                }
            });
            
            // 添加窗口大小变化监听，确保布局正确
            window.addEventListener('resize', function() {
                setTimeout(syncLineNumbersScroll, 100);
            });
            
            // 初始化行号
            updateLineNumbers();
        }
        
        function updateLineNumbers() {
            const codeInput = document.getElementById('r_code_input');
            const lineNumbers = document.getElementById('code-line-numbers');
            
            if (!codeInput || !lineNumbers) return;
            
            const lines = codeInput.value.split('\n');
            const lineCount = Math.max(lines.length, 10); // 至少显示10行
            
            let numbersHtml = '';
            for (let i = 1; i <= lineCount; i++) {
                const isSelected = selectedLines.has(i);
                numbersHtml += `<span class="line-number ${isSelected ? 'selected' : ''}" 
                    data-line="${i}" onclick="toggleLineSelection(${i})">${i}</span>`;
            }
            
            // 创建内部容器来实现滚动
            lineNumbers.innerHTML = `<div class="line-numbers-content">${numbersHtml}</div>`;
        }
        
        function syncLineNumbersScroll() {
            const codeInput = document.getElementById('r_code_input');
            const lineNumbers = document.getElementById('code-line-numbers');
            
            if (!codeInput || !lineNumbers) return;
            
            const lineNumbersContent = lineNumbers.querySelector('.line-numbers-content');
            if (!lineNumbersContent) return;
            
            // 获取滚动位置
            const scrollTop = codeInput.scrollTop;
            
            // 应用滚动变换
            lineNumbersContent.style.transform = `translateY(-${scrollTop}px)`;
        }
        
        function toggleLineSelection(lineNumber) {
            if (selectedLines.has(lineNumber)) {
                selectedLines.delete(lineNumber);
            } else {
                selectedLines.add(lineNumber);
            }
            
            updateLineNumbers();
            updateSelectedLinesDisplay();
        }
        
        function updateSelectedLinesDisplay() {
            const selectedLinesInfo = document.getElementById('selected-lines-info');
            const selectedLinesDisplay = document.getElementById('selected-lines-display');
            const selectedLinesInput = document.getElementById('selected_lines_input');
            
            if (!selectedLinesInfo || !selectedLinesDisplay || !selectedLinesInput) return;
            
            if (selectedLines.size > 0) {
                const sortedLines = Array.from(selectedLines).sort((a, b) => a - b);
                selectedLinesDisplay.textContent = sortedLines.join(', ');
                selectedLinesInput.value = JSON.stringify(sortedLines);
                selectedLinesInfo.style.display = 'block';
            } else {
                selectedLinesInfo.style.display = 'none';
                selectedLinesInput.value = '';
            }
        }
        
        function clearLineSelection() {
            selectedLines.clear();
            updateLineNumbers();
            updateSelectedLinesDisplay();
        }
        
        // 修改清空表单函数以支持代码解释表单
        function clearExplanationForm() {
            const form = document.getElementById('explanation-form');
            form.reset();
            clearLineSelection();
            clearResult('explanation');
        }

        // 验证文件
        function validateFile(file) {
            const maxSize = 10 * 1024 * 1024; // 10MB
            const allowedTypes = ['.txt', '.r', '.R', '.py', '.md', '.doc', '.docx', '.pdf'];
            
            // 检查文件大小
            if (file.size > maxSize) {
                alert('文件大小不能超过10MB');
                clearFile();
                return false;
            }
            
            // 检查文件类型
            const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
            if (!allowedTypes.includes(fileExtension) && !allowedTypes.includes(fileExtension.toUpperCase())) {
                alert('不支持的文件格式。支持的格式：' + allowedTypes.join(', '));
                clearFile();
                return false;
            }
            
            return true;
        }

        // 格式化文件大小
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // ========== 聊天功能 ==========

        // 初始化聊天功能
        function setupChatFeatures() {
            const chatInput = document.getElementById('chat-message-input');
            const chatForm = document.getElementById('chat-form');
            const sendButton = document.querySelector('.btn-send');
            const charCount = document.getElementById('char-count');

            if (!chatInput || !chatForm) return;

            // 监听输入变化
            chatInput.addEventListener('input', function() {
                const length = this.value.length;
                charCount.textContent = length;
                
                // 控制发送按钮状态
                sendButton.disabled = length === 0;
                
                // 自动调整高度
                autoResizeTextarea(this);
            });

            // 键盘事件处理
            chatInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    if (this.value.trim()) {
                        chatForm.dispatchEvent(new Event('submit'));
                    }
                }
            });

            // 表单提交
            chatForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const message = chatInput.value.trim();
                if (message) {
                    sendChatMessage(message);
                    chatInput.value = '';
                    chatInput.dispatchEvent(new Event('input'));
                }
            });
        }

        // 自动调整文本框高度
        function autoResizeTextarea(textarea) {
            textarea.style.height = 'auto';
            const newHeight = Math.min(textarea.scrollHeight, 120);
            textarea.style.height = newHeight + 'px';
        }

        // 发送聊天消息
        function sendChatMessage(message) {
            const sendButton = document.querySelector('.btn-send');
            
            // 添加发送动画
            sendButton.classList.add('sending');
            sendButton.disabled = true;
            
            // 添加用户消息到界面
            addMessageToChat(message, 'user');
            
            // 显示打字指示器
            showTypingIndicator();
            
            // 准备表单数据
            const formData = new FormData();
            formData.append('message', message);
            formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
            
            // 发送请求
            fetch('{% url "rcode_helper:chat" %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                hideTypingIndicator();
                
                // 移除发送动画
                sendButton.classList.remove('sending');
                sendButton.disabled = false;
                
                if (data.error) {
                    addMessageToChat('抱歉，处理您的消息时出现了错误。请稍后重试。', 'ai', true);
                } else {
                    // 延迟显示AI回复，模拟真实对话
                    setTimeout(() => {
                        addMessageToChat(data.ai_response || data.response, 'ai');
                        
                        // 播放提示音效（可选）
                        playNotificationSound();
                    }, 500);
                }
            })
            .catch(error => {
                console.error('Chat error:', error);
                hideTypingIndicator();
                
                // 移除发送动画
                sendButton.classList.remove('sending');
                sendButton.disabled = false;
                
                addMessageToChat('网络连接出现问题，请检查网络后重试。', 'ai', true);
            });
        }

        // 添加消息到聊天界面
        function addMessageToChat(message, sender, isError = false) {
            const chatMessages = document.getElementById('chat-messages');
            const messageGroup = document.createElement('div');
            messageGroup.className = 'message-group';
            
            const currentTime = new Date().toLocaleTimeString('zh-CN', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            const isUser = sender === 'user';
            const avatarIcon = isUser ? 'fas fa-user' : 'fas fa-robot';
            
            messageGroup.innerHTML = `
                <div class="message ${isUser ? 'user-message' : 'ai-message'}">
                    <div class="message-avatar">
                        <i class="${avatarIcon}"></i>
                    </div>
                    <div class="message-content">
                        <div class="message-bubble ${isError ? 'error' : ''}">
                            <div class="message-text">${formatMessageText(message)}</div>
                        </div>
                        <div class="message-time">
                            <i class="fas fa-clock me-1"></i>
                            ${currentTime}
                        </div>
                    </div>
                </div>
            `;
            
            // 添加到聊天区域
            chatMessages.appendChild(messageGroup);
            
            // 平滑滚动到底部
            scrollToBottom();
            
            // 高亮代码
            if (typeof Prism !== 'undefined') {
                Prism.highlightAll();
            }
        }

        // 平滑滚动到底部
        function scrollToBottom() {
            const chatMessages = document.getElementById('chat-messages');
            const scrollTarget = chatMessages.scrollHeight - chatMessages.clientHeight;
            
            // 使用动画滚动
            const startTime = performance.now();
            const startScroll = chatMessages.scrollTop;
            const distance = scrollTarget - startScroll;
            const duration = 300;
            
            function scrollAnimation(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                // 使用easeOutCubic缓动函数
                const easeProgress = 1 - Math.pow(1 - progress, 3);
                
                chatMessages.scrollTop = startScroll + distance * easeProgress;
                
                if (progress < 1) {
                    requestAnimationFrame(scrollAnimation);
                }
            }
            
            requestAnimationFrame(scrollAnimation);
        }

        // 格式化消息文本（增强版）
        function formatMessageText(text) {
            if (!text) return '';
            
            // 转换换行符为<br>
            text = text.replace(/\n/g, '<br>');
            
            // 代码块高亮
            text = text.replace(/```(\w+)?\n?([\s\S]*?)```/g, (match, lang, code) => {
                const language = lang || 'r';
                return `<pre><code class="language-${language}">${code.trim()}</code></pre>`;
            });
            
            // 行内代码
            text = text.replace(/`([^`]+)`/g, '<code class="inline-code">$1</code>');
            
            // 链接检测
            text = text.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" rel="noopener">$1</a>');
            
            // 表情符号支持
            text = text.replace(/:\)/g, '😊');
            text = text.replace(/:\(/g, '😢');
            text = text.replace(/:D/g, '😄');
            text = text.replace(/;\)/g, '😉');
            
            return text;
        }

        // 播放提示音效
        function playNotificationSound() {
            // 创建音频上下文（Web Audio API）
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                // 设置频率和音量
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
            } catch (e) {
                // 如果音频不支持，静默失败
                console.log('Audio notification not supported');
            }
        }

        // 显示打字指示器（增强版）
        function showTypingIndicator() {
            const typingIndicator = document.getElementById('typing-indicator');
            
            typingIndicator.style.display = 'block';
            scrollToBottom();
            
            // 随机延迟，让AI显得更"人性化"
            const randomDelay = 1000 + Math.random() * 2000; // 1-3秒随机延迟
            
            return new Promise(resolve => {
                setTimeout(resolve, randomDelay);
            });
        }

        // 清空聊天记录（增强版）
        function clearChatHistory() {
            if (confirm('确定要清空所有聊天记录吗？此操作不可撤销。')) {
                const chatMessages = document.getElementById('chat-messages');
                
                // 添加清空动画
                chatMessages.style.opacity = '0';
                chatMessages.style.transform = 'scale(0.95)';
                
                setTimeout(() => {
                    // 只保留欢迎消息
                    const welcomeMessage = chatMessages.querySelector('.message-group');
                    chatMessages.innerHTML = '';
                    if (welcomeMessage) {
                        chatMessages.appendChild(welcomeMessage);
                    }
                    
                    // 恢复样式
                    chatMessages.style.opacity = '1';
                    chatMessages.style.transform = 'scale(1)';
                    
                    // 显示清空提示
                    setTimeout(() => {
                        addMessageToChat('聊天记录已清空，让我们重新开始吧！ 😊', 'ai');
                    }, 500);
                }, 300);
            }
        }

        // 智能建议功能
        function showQuickSuggestions() {
            const suggestions = [
                "R语言基础语法有哪些？",
                "如何进行数据可视化？",
                "什么是线性回归分析？",
                "如何处理缺失数据？",
                "R中的循环结构怎么写？"
            ];
            
            // TODO: 可以在界面中显示这些建议按钮
            return suggestions;
        }

        // ====== Dashboard 高级代码编辑器功能 ======
        let dashboardEditor = null;
        let dashboardCurrentTheme = 'vs-dark';
        let dashboardSymbolMode = false;

        // 初始化Dashboard编辑器
        async function initializeDashboardEditor() {
            try {
                // 确保AdvancedCodeEditor类可用
                if (typeof AdvancedCodeEditor === 'undefined') {
                    console.warn('AdvancedCodeEditor未加载，使用基础编辑器');
                    return;
                }

                dashboardEditor = new AdvancedCodeEditor('#dashboard-code-editor', {
                    language: 'r',
                    theme: dashboardCurrentTheme,
                    lineNumbers: true,
                    wordWrap: false,
                    minimap: false,
                    fontSize: 14,
                    height: 300,
                    scrollBeyondLastLine: false,
                    automaticLayout: true,
                    renderWhitespace: 'selection',
                    renderControlCharacters: false,
                    enableSymbolReplacement: false
                });

                // 监听内容变化
                dashboardEditor.container.addEventListener('contentChange', function(e) {
                    const content = e.detail.content;
                    const hiddenTextarea = document.getElementById('{{ explanation_form.r_code.id_for_label }}');
                    if (hiddenTextarea) {
                        hiddenTextarea.value = content;
                    }
                    updateDashboardEditorStats();
                });

                // 监听选择变化
                dashboardEditor.container.addEventListener('selectionChange', function(e) {
                    updateDashboardSelectedLinesInfo();
                });

                updateDashboardEditorStats();

            } catch (error) {
                console.warn('Dashboard编辑器初始化失败:', error);
            }
        }

        function updateDashboardEditorStats() {
            if (!dashboardEditor) return;

            const content = dashboardEditor.getValue();
            const lines = content.split('\n').length;
            const chars = content.length;

            const lineCountEl = document.getElementById('dashboard-line-count');
            const charCountEl = document.getElementById('dashboard-char-count');
            
            if (lineCountEl) lineCountEl.textContent = `${lines} 行`;
            if (charCountEl) charCountEl.textContent = `${chars} 字符`;
        }

        function updateDashboardSelectedLinesInfo() {
            if (!dashboardEditor) return;

            const selectedLines = dashboardEditor.getSelectedLines();
            const count = selectedLines.length;

            const displayEl = document.getElementById('dashboard-selected-lines-display');
            const infoDiv = document.getElementById('dashboard-selected-lines-info');
            const selectedLinesInput = document.querySelector('input[name="selected_lines"]');

            if (displayEl) displayEl.textContent = count;

            if (count > 0) {
                if (infoDiv) infoDiv.style.display = 'block';
                if (selectedLinesInput) selectedLinesInput.value = selectedLines.join(',');
            } else {
                if (infoDiv) infoDiv.style.display = 'none';
                if (selectedLinesInput) selectedLinesInput.value = '';
            }
        }

        function clearDashboardEditor() {
            if (dashboardEditor) {
                dashboardEditor.setValue('');
                dashboardEditor.clearSelection();
                showDashboardNotification('编辑器已清空', 'info');
            }
        }

        function toggleDashboardSymbolMode() {
            dashboardSymbolMode = !dashboardSymbolMode;
            const symbolText = document.getElementById('dashboard-symbol-text');
            const btn = symbolText?.parentElement;

            if (dashboardSymbolMode) {
                if (symbolText) symbolText.textContent = '标准';
                if (btn) {
                    btn.classList.remove('btn-outline-info');
                    btn.classList.add('btn-info');
                }
                showDashboardNotification('符号模式已启用', 'info');
            } else {
                if (symbolText) symbolText.textContent = '符号';
                if (btn) {
                    btn.classList.remove('btn-info');
                    btn.classList.add('btn-outline-info');
                }
                showDashboardNotification('标准模式已启用', 'info');
            }

            if (dashboardEditor && dashboardEditor.options) {
                dashboardEditor.options.enableSymbolReplacement = dashboardSymbolMode;
            }
        }

        function formatDashboardCode() {
            if (dashboardEditor) {
                dashboardEditor.formatCode();
                showDashboardNotification('代码已格式化', 'success');
            }
        }

        function toggleDashboardTheme() {
            dashboardCurrentTheme = dashboardCurrentTheme === 'vs-dark' ? 'vs' : 'vs-dark';
            const themeText = document.getElementById('dashboard-theme-text');

            if (dashboardCurrentTheme === 'vs-dark') {
                if (themeText) themeText.textContent = '深色';
                if (dashboardEditor && dashboardEditor.editor) {
                    monaco.editor.setTheme('vs-dark');
                }
            } else {
                if (themeText) themeText.textContent = '浅色';
                if (dashboardEditor && dashboardEditor.editor) {
                    monaco.editor.setTheme('vs');
                }
            }
        }

        function loadDashboardExample() {
            const exampleCode = `# R语言数据分析入门示例
# 作者：R语言助手
# 时间：${new Date().toLocaleDateString()}

# 1. 加载必要的包
library(ggplot2)
library(dplyr)

# 2. 创建示例数据
students <- data.frame(
    name = c("张三", "李四", "王五", "赵六", "孙七"),
    math_score = c(85, 92, 78, 96, 88),
    english_score = c(90, 85, 92, 89, 94),
    age = c(20, 21, 19, 22, 20)
)

# 3. 数据探索
print("=== 数据概览 ===")
head(students)
summary(students)

# 4. 数据分析
print("=== 分析结果 ===")
# 计算平均分
students$average_score <- (students$math_score + students$english_score) / 2

# 找出成绩最好的学生
best_student <- students[which.max(students$average_score), ]
print(paste("成绩最好的学生是:", best_student$name))

# 5. 数据可视化
# 创建散点图
ggplot(students, aes(x = math_score, y = english_score)) +
    geom_point(aes(color = name), size = 3) +
    geom_smooth(method = "lm", se = FALSE, color = "red") +
    labs(title = "数学成绩与英语成绩的关系",
         x = "数学成绩", 
         y = "英语成绩") +
    theme_minimal()

print("示例代码执行完成！")`;

            if (dashboardEditor) {
                dashboardEditor.setValue(exampleCode);
                showDashboardNotification('示例代码已加载', 'success');
            }
        }

        function clearDashboardLineSelection() {
            if (dashboardEditor) {
                dashboardEditor.clearSelection();
                updateDashboardSelectedLinesInfo();
                showDashboardNotification('已清除行选择', 'info');
            }
        }

        function showDashboardNotification(message, type = 'info') {
            // 创建通知元素
            const notification = document.createElement('div');
            notification.className = `alert alert-${type === 'error' ? 'danger' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info'} dashboard-notification`;
            notification.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="fas fa-${type === 'error' ? 'exclamation-triangle' : type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-circle' : 'info-circle'} me-2"></i>
                    ${message}
                </div>
            `;

            // 添加样式
            notification.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                z-index: 9999;
                min-width: 250px;
                animation: slideInRight 0.3s ease;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                border: none;
                border-radius: 8px;
            `;

            document.body.appendChild(notification);

            // 自动移除
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // 页面加载完成后初始化Dashboard编辑器
        document.addEventListener('DOMContentLoaded', function() {
            // 延迟初始化，确保所有资源都已加载
            setTimeout(() => {
                initializeDashboardEditor();
            }, 1000);
        });
    </script>
    
    <!-- 高级代码编辑器资源 -->
    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@latest/min/vs/loader.js"></script>
    <!-- 高级代码编辑器模块化路径 -->
    <link rel="stylesheet" href="{% static 'css/components/advanced-code-editor.css' %}">
    <script src="{% static 'js/modules/advanced-code-editor.js' %}"></script>
    
    <!-- Dashboard编辑器样式 -->
    <style>
    .advanced-code-input-container {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        overflow: hidden;
        background: #f8f9fa;
    }
    
    .advanced-code-input-container #dashboard-code-editor {
        height: 300px;
        border: none;
    }
    
    .code-editor-toolbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 12px;
        background: #e9ecef;
        border-top: 1px solid #dee2e6;
        flex-wrap: wrap;
        gap: 8px;
    }
    
    .toolbar-section {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
    }
    
    .dashboard-notification {
        font-size: 14px;
    }
    
    /* 响应式优化 */
    @media (max-width: 768px) {
        .advanced-code-input-container #dashboard-code-editor {
            height: 250px;
        }
        
        .code-editor-toolbar {
            flex-direction: column;
            align-items: stretch;
        }
        
        .toolbar-section {
            justify-content: center;
        }
    }
    </style>
    </script>
    
    <!-- 主题系统脚本 -->
    <!-- 主题脚本新路径 -->
    <script src="{% static 'js/lib/themes.js' %}"></script>
</body>
</html>