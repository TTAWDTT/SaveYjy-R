<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rè¯­è¨€æ™ºèƒ½åŠ©æ‰‹ - ä¸»æ§é¢æ¿</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    {% load static %}
    <!-- ä½¿ç”¨æ¨¡å—åŒ–åçš„ä¸»é¢˜æ ·å¼è·¯å¾„ -->
    <link href="{% static 'css/themes/themes.css' %}" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            /* èƒŒæ™¯ç”±ä¸»é¢˜ç³»ç»Ÿæ§åˆ¶ */
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* ä¸»å®¹å™¨ */
        .main-container {
            display: flex;
            min-height: 100vh;
        }

        /* å·¦ä¾§å¯¼èˆªæ  */
        .sidebar {
            width: 280px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(255, 182, 193, 0.3);
            padding: 30px 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 5px 0 30px rgba(255, 105, 180, 0.15);
        }

        .sidebar-header {
            padding: 0 30px 30px;
            border-bottom: 1px solid rgba(255, 182, 193, 0.2);
            margin-bottom: 30px;
        }

        .sidebar-brand {
            display: flex;
            align-items: center;
            text-decoration: none;
            color: #ff1493;
            font-weight: 700;
            font-size: 20px;
        }

        .sidebar-brand i {
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, #ff69b4, #ff1493);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            margin-right: 15px;
            font-size: 20px;
        }

        .user-info {
            margin-top: 15px;
            padding: 15px;
            background: rgba(255, 182, 193, 0.1);
            border-radius: 15px;
            border: 1px solid rgba(255, 182, 193, 0.2);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #ff69b4, #ff1493);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            margin-right: 12px;
        }

        .user-details h6 {
            margin: 0;
            color: #ff1493;
            font-weight: 600;
            font-size: 14px;
        }

        .user-details p {
            margin: 0;
            color: #888;
            font-size: 12px;
        }

        /* å¯¼èˆªèœå• */
        .nav-menu {
            padding: 0 20px;
        }

        .nav-item {
            margin-bottom: 8px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            color: #666;
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .nav-link i {
            width: 22px;
            margin-right: 15px;
            text-align: center;
            font-size: 18px;
        }

        .nav-link:hover {
            color: #ff1493;
            background: rgba(255, 105, 180, 0.1);
            transform: translateX(5px);
        }

        .nav-link.active {
            background: linear-gradient(135deg, #ff69b4, #ff1493);
            color: white;
            box-shadow: 0 8px 25px rgba(255, 105, 180, 0.3);
        }

        .nav-link.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            width: 4px;
            height: 100%;
            background: rgba(255, 255, 255, 0.5);
        }

        /* é€€å‡ºæŒ‰é’® */
        .logout-section {
            position: absolute;
            bottom: 30px;
            left: 20px;
            right: 20px;
        }

        .logout-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 12px;
            background: rgba(220, 53, 69, 0.1);
            color: #dc3545;
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.3s ease;
            border: 1px solid rgba(220, 53, 69, 0.2);
        }

        .logout-btn:hover {
            background: #dc3545;
            color: white;
        }

        /* ä¸»å†…å®¹åŒºåŸŸ */
        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 30px;
            position: relative;
        }

        /* å†…å®¹å¡ç‰‡ */
        .content-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 25px;
            padding: 40px;
            box-shadow: 
                0 20px 60px rgba(255, 105, 180, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.3);
            min-height: calc(100vh - 60px);
        }

        /* é¡µé¢æ ‡é¢˜ */
        .page-header {
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 2px solid rgba(255, 182, 193, 0.2);
        }

        .page-title {
            font-size: 32px;
            font-weight: 700;
            color: #ff1493;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }

        .page-title i {
            margin-right: 15px;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #ff69b4, #ff1493);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 22px;
        }

        .page-subtitle {
            color: #888;
            font-size: 16px;
            margin: 0;
        }

        /* è¡¨å•æ ·å¼ */
        .form-section {
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-label {
            font-weight: 600;
            color: #ff1493;
            margin-bottom: 10px;
            font-size: 16px;
            display: flex;
            align-items: center;
        }

        .form-label i {
            margin-right: 8px;
        }

        .form-control {
            border: 2px solid rgba(255, 105, 180, 0.2);
            border-radius: 15px;
            padding: 15px 20px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.8);
        }

        .form-control:focus {
            border-color: #ff69b4;
            box-shadow: 0 0 0 0.2rem rgba(255, 105, 180, 0.25);
            background: rgba(255, 255, 255, 0.95);
        }

        /* ä»£ç è¾“å…¥å®¹å™¨ */
        .code-input-container {
            position: relative;
            display: flex;
            align-items: stretch;
            background: #f8f9fa;
            border: 2px solid rgba(255, 105, 180, 0.2);
            border-radius: 8px;
            overflow: hidden;
        }

        .code-input-container .form-control {
            font-family: 'Courier New', monospace;
            line-height: 1.6;
            resize: vertical;
            padding: 15px 15px 15px 50px;
            background: transparent;
            border: none;
            outline: none;
            flex: 1;
            min-height: 200px;
        }

        /* è¡Œå·æ˜¾ç¤º */
        .code-line-numbers {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 45px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            color: #6c757d;
            user-select: none;
            z-index: 10;
            pointer-events: none;
            background: rgba(248, 249, 250, 0.9);
            border-right: 1px solid rgba(255, 105, 180, 0.1);
            padding: 15px 8px 15px 0;
            overflow: hidden;
        }

        .line-numbers-content {
            transition: transform 0.1s ease-out;
            will-change: transform;
        }

        .line-number {
            display: block;
            padding: 0 8px;
            text-align: right;
            min-width: 30px;
            cursor: pointer;
            pointer-events: all;
            border-radius: 3px;
            transition: all 0.2s ease;
            height: 1.6em;
        }

        .line-number:hover {
            background: rgba(255, 105, 180, 0.1);
            color: #ff1493;
        }

        .line-number.selected {
            background: rgba(255, 105, 180, 0.3);
            color: #ff1493;
            font-weight: bold;
        }

        /* é€‰ä¸­è¡Œä¿¡æ¯æ˜¾ç¤º */
        .selected-lines-info {
            margin-top: 10px;
            padding: 10px 15px;
            background: rgba(255, 105, 180, 0.1);
            border: 1px solid rgba(255, 105, 180, 0.3);
            border-radius: 8px;
            font-size: 14px;
            color: #ff1493;
        }

        /* æŒ‰é’®æ ·å¼ */
        .btn-pink {
            background: linear-gradient(135deg, #ff69b4, #ff1493);
            border: none;
            border-radius: 50px;
            padding: 15px 30px;
            font-weight: 600;
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(255, 105, 180, 0.3);
            position: relative;
            overflow: hidden;
        }

        .btn-pink::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }

        .btn-pink:hover::before {
            left: 100%;
        }

        .btn-pink:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(255, 105, 180, 0.4);
            color: white;
        }

        .btn-secondary {
            background: rgba(108, 117, 125, 0.1);
            border: 2px solid rgba(108, 117, 125, 0.2);
            color: #6c757d;
            border-radius: 50px;
            padding: 13px 28px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            background: #6c757d;
            border-color: #6c757d;
            color: white;
        }

        /* åŠ è½½çŠ¶æ€ */
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 105, 180, 0.2);
            border-left: 4px solid #ff69b4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: #ff1493;
            font-weight: 600;
            font-size: 18px;
        }

        /* ç»“æœæ˜¾ç¤º */
        .result-section {
            display: none;
            margin-top: 30px;
        }

        .result-card {
            background: rgba(255, 182, 193, 0.1);
            border: 1px solid rgba(255, 182, 193, 0.3);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 25px;
        }

        .result-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .result-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #ff69b4, #ff1493);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            margin-right: 15px;
        }

        .result-title {
            font-weight: 600;
            color: #ff1493;
            margin: 0;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .sidebar {
                width: 250px;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
                padding: 20px;
            }

            .content-card {
                padding: 25px;
            }

            .page-title {
                font-size: 24px;
            }
        }

        /* éšè—ç±» */
        .d-none {
            display: none !important;
        }

        /* ç²’å­èƒŒæ™¯ */
        .particles-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
        }

        .particle {
            position: absolute;
            width: 6px;
            height: 6px;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 50%;
            animation: float 8s ease-in-out infinite;
        }

        .particle:nth-child(1) { top: 20%; left: 20%; animation-delay: 0s; }
        .particle:nth-child(2) { top: 60%; left: 80%; animation-delay: 2s; }
        .particle:nth-child(3) { top: 80%; left: 10%; animation-delay: 4s; }
        .particle:nth-child(4) { top: 40%; left: 70%; animation-delay: 1s; }
        .particle:nth-child(5) { top: 10%; left: 90%; animation-delay: 3s; }

        @keyframes float {
            0%, 100% { transform: translateY(0px); opacity: 0.7; }
            50% { transform: translateY(-20px); opacity: 1; }
        }

        /* ========== æ–‡ä»¶ä¸Šä¼ æ ·å¼ ========== */
        .input-method-selector {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 10px;
            border: 1px solid rgba(255, 182, 193, 0.3);
        }

        .input-method-selector .form-check {
            margin: 0;
        }

        .input-method-selector .form-check-label {
            font-weight: 500;
            color: #666;
            cursor: pointer;
            padding: 8px 16px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .input-method-selector .form-check-input:checked + .form-check-label {
            background: linear-gradient(135deg, #ff69b4, #ff1493);
            color: white;
            transform: translateY(-2px);
        }

        .file-upload-container {
            position: relative;
        }

        .file-drop-zone {
            border: 2px dashed #ff69b4;
            border-radius: 15px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
        }

        .file-drop-zone:hover {
            border-color: #ff1493;
            background: rgba(255, 105, 180, 0.1);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 105, 180, 0.2);
        }

        .file-drop-zone.dragover {
            border-color: #ff1493;
            background: rgba(255, 105, 180, 0.15);
            transform: scale(1.02);
        }

        .file-drop-content {
            pointer-events: none;
        }

        .file-preview {
            margin-top: 15px;
        }

        .file-info-card {
            display: flex;
            align-items: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            border: 1px solid rgba(255, 182, 193, 0.3);
            backdrop-filter: blur(10px);
        }

        .file-info-card i {
            color: #ff69b4;
            font-size: 18px;
        }

        #homework_file_input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        /* æ–‡ä»¶ä¸Šä¼ åŠ¨ç”» */
        .file-uploading {
            position: relative;
            overflow: hidden;
        }

        .file-uploading::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 105, 180, 0.3), transparent);
            animation: loading-sweep 2s infinite;
        }

        @keyframes loading-sweep {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        /* ========== èŠå¤©ç•Œé¢æ ·å¼ ========== */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 200px);
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 10px 40px rgba(255, 105, 180, 0.1);
            overflow: hidden;
        }

        /* èŠå¤©å¤´éƒ¨ */
        .chat-header {
            padding: 20px 25px;
            background: linear-gradient(135deg, rgba(255, 105, 180, 0.1), rgba(255, 20, 147, 0.1));
            border-bottom: 1px solid rgba(255, 182, 193, 0.3);
        }

        .chat-header-content {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .ai-avatar {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #ff69b4, #ff1493);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            box-shadow: 0 4px 15px rgba(255, 105, 180, 0.3);
        }

        .chat-info {
            flex: 1;
        }

        .chat-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin: 0 0 5px 0;
        }

        .chat-status {
            margin: 0;
            font-size: 14px;
            color: #666;
            display: flex;
            align-items: center;
        }

        .chat-status.online {
            color: #28a745;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: #28a745;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* æ¶ˆæ¯åŒºåŸŸ */
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            scroll-behavior: smooth;
        }

        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: rgba(255, 182, 193, 0.1);
            border-radius: 3px;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: rgba(255, 105, 180, 0.3);
            border-radius: 3px;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 105, 180, 0.5);
        }

        .message-group {
            margin-bottom: 20px;
        }

        .message {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            max-width: 85%;
        }

        .message.user-message {
            flex-direction: row-reverse;
            margin-left: auto;
        }

        .message.ai-message {
            margin-right: auto;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
        }

        .ai-message .message-avatar {
            background: linear-gradient(135deg, #ff69b4, #ff1493);
            color: white;
        }

        .user-message .message-avatar {
            background: linear-gradient(135deg, #6c757d, #495057);
            color: white;
        }

        .message-content {
            flex: 1;
        }

        .message-bubble {
            padding: 12px 16px;
            border-radius: 18px;
            position: relative;
            word-wrap: break-word;
        }

        .ai-message .message-bubble {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(255, 182, 193, 0.2);
            border-bottom-left-radius: 4px;
        }

        .user-message .message-bubble {
            background: linear-gradient(135deg, #ff69b4, #ff1493);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message-text {
            line-height: 1.5;
            font-size: 14px;
        }

        .message-time {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
            display: flex;
            align-items: center;
        }

        .user-message .message-time {
            justify-content: flex-end;
            color: rgba(255, 255, 255, 0.8);
        }

        .welcome-list {
            margin: 10px 0 0 0;
            padding-left: 20px;
        }

        .welcome-list li {
            margin-bottom: 5px;
            color: #666;
        }

        /* æ‰“å­—æŒ‡ç¤ºå™¨ */
        .typing-indicator .message-bubble {
            padding: 12px 20px;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .typing-dots span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ff69b4;
            animation: typing 1.4s infinite;
        }

        .typing-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: scale(1);
                opacity: 0.5;
            }
            30% {
                transform: scale(1.2);
                opacity: 1;
            }
        }

        /* è¾“å…¥åŒºåŸŸ */
        .chat-input-area {
            padding: 20px 25px;
            background: rgba(255, 255, 255, 0.7);
            border-top: 1px solid rgba(255, 182, 193, 0.3);
        }

        .input-container {
            position: relative;
        }

        .input-group {
            display: flex;
            align-items: flex-end;
            background: white;
            border-radius: 25px;
            border: 2px solid rgba(255, 182, 193, 0.3);
            padding: 8px 15px;
            transition: all 0.3s ease;
        }

        .input-group:focus-within {
            border-color: #ff69b4;
            box-shadow: 0 0 0 0.2rem rgba(255, 105, 180, 0.25);
        }

        .chat-input {
            border: none;
            outline: none;
            resize: none;
            flex: 1;
            min-height: 20px;
            max-height: 120px;
            font-size: 14px;
            line-height: 1.5;
            background: transparent;
        }

        .chat-input::placeholder {
            color: #999;
        }

        .input-actions {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-left: 10px;
        }

        .btn-ghost {
            background: none;
            border: none;
            color: #999;
            padding: 6px;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .btn-ghost:hover {
            background: rgba(255, 105, 180, 0.1);
            color: #ff69b4;
        }

        .btn-send {
            background: linear-gradient(135deg, #ff69b4, #ff1493);
            border: none;
            color: white;
            padding: 8px;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .btn-send:hover:not(:disabled) {
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(255, 105, 180, 0.4);
        }

        .btn-send:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .input-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
            padding: 0 5px;
        }

        /* æ¶ˆæ¯åŠ¨ç”» */
        .message-group {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-bubble {
            transition: all 0.3s ease;
        }

        .message-bubble:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        /* é”™è¯¯æ¶ˆæ¯æ ·å¼ */
        .message-bubble.error {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24) !important;
            color: white;
            border: 1px solid #ff4757;
        }

        /* å‘é€æŒ‰é’®åŠ¨ç”» */
        .btn-send.sending {
            animation: pulse-send 0.6s ease-in-out infinite;
        }

        @keyframes pulse-send {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* éŸ³ç¬¦åŠ¨ç”»è£…é¥° */
        .chat-container::before {
            content: 'â™ª';
            position: absolute;
            top: 20px;
            right: 80px;
            font-size: 20px;
            color: rgba(255, 105, 180, 0.3);
            animation: float-note 3s ease-in-out infinite;
            z-index: 1;
        }

        @keyframes float-note {
            0%, 100% { transform: translateY(0px) rotate(0deg); opacity: 0.3; }
            50% { transform: translateY(-10px) rotate(5deg); opacity: 0.6; }
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .chat-container {
                height: calc(100vh - 150px);
                margin: 10px;
                border-radius: 15px;
            }

            .chat-header {
                padding: 15px 20px;
            }

            .chat-messages {
                padding: 15px;
            }

            .message {
                max-width: 95%;
            }

            .chat-input-area {
                padding: 15px 20px;
            }

            .ai-avatar {
                width: 40px;
                height: 40px;
                font-size: 18px;
            }

            .input-footer small {
                font-size: 11px;
            }

            .input-footer .ms-3 {
                display: none;
            }

            .chat-container::before {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- ç²’å­èƒŒæ™¯ -->
    <div class="particles-bg">
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
    </div>

    <div class="main-container">
        <!-- å·¦ä¾§å¯¼èˆªæ  -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <a href="#" class="sidebar-brand">
                    <i class="fas fa-chart-line"></i>
                    Rè¯­è¨€æ™ºèƒ½åŠ©æ‰‹
                </a>
                <div class="user-info d-flex align-items-center">
                    <div class="user-avatar">{{ username|first|upper }}</div>
                    <div class="user-details">
                        <h6>{{ username }}</h6>
                        <p>åœ¨çº¿ç”¨æˆ·</p>
                    </div>
                </div>
            </div>

            <div class="nav-menu">
                <div class="nav-item">
                    <a href="#" class="nav-link active" data-section="homework">
                        <i class="fas fa-clipboard-list"></i>
                        <span>Answer - ä½œä¸šè§£ç­”</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="#" class="nav-link" data-section="explanation">
                        <i class="fas fa-code"></i>
                        <span>Explain - ä»£ç è§£é‡Š</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="#" class="nav-link" data-section="chat">
                        <i class="fas fa-comments"></i>
                        <span>Talk - æ™ºèƒ½å¯¹è¯</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="{% url 'rcode_helper:history' %}" class="nav-link">
                        <i class="fas fa-history"></i>
                        <span>å†å²è®°å½•</span>
                    </a>
                </div>
            </div>

            <div class="logout-section">
                <a href="{% url 'rcode_helper:logout' %}" class="logout-btn">
                    <i class="fas fa-sign-out-alt me-2"></i>
                    é€€å‡ºç™»å½•
                </a>
            </div>
        </nav>

        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <main class="main-content">
            <div class="content-card">
                <!-- ä½œä¸šè§£ç­”éƒ¨åˆ† -->
                <div id="homework-section" class="content-section">
                    <div class="page-header">
                        <h1 class="page-title">
                            <i class="fas fa-clipboard-list"></i>
                            ä½œä¸šé¢˜è§£ç­”
                        </h1>
                        <p class="page-subtitle">è¾“å…¥Rè¯­è¨€ä½œä¸šé¢˜ï¼ŒAIå°†ä¸ºæ‚¨ç”Ÿæˆä¸‰ç§ä¸åŒçš„è§£å†³æ–¹æ¡ˆ</p>
                    </div>

                    <form id="homework-form" class="form-section" enctype="multipart/form-data">
                        {% csrf_token %}
                        
                        <!-- è¾“å…¥æ–¹å¼é€‰æ‹© -->
                        <div class="form-group mb-4">
                            <label class="form-label">
                                <i class="fas fa-cog"></i>
                                è¾“å…¥æ–¹å¼
                            </label>
                            <div class="input-method-selector">
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="input_method" id="input_text" value="text" checked onchange="toggleInputMethod()">
                                    <label class="form-check-label" for="input_text">
                                        <i class="fas fa-keyboard me-2"></i>æ–‡æœ¬è¾“å…¥
                                    </label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="input_method" id="input_file" value="file" onchange="toggleInputMethod()">
                                    <label class="form-check-label" for="input_file">
                                        <i class="fas fa-file-upload me-2"></i>æ–‡ä»¶ä¸Šä¼ 
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- æ–‡æœ¬è¾“å…¥åŒºåŸŸ -->
                        <div id="text-input-area" class="form-group">
                            <label for="{{ homework_form.homework_question.id_for_label }}" class="form-label">
                                <i class="fas fa-edit"></i>
                                {{ homework_form.homework_question.label }}
                            </label>
                            {{ homework_form.homework_question }}
                            <div class="form-text text-muted mt-2">{{ homework_form.homework_question.help_text }}</div>
                        </div>
                        
                        <!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
                        <div id="file-input-area" class="form-group" style="display: none;">
                            <label for="{{ homework_form.homework_file.id_for_label }}" class="form-label">
                                <i class="fas fa-file-upload"></i>
                                {{ homework_form.homework_file.label }}
                            </label>
                            <div class="file-upload-container">
                                <div class="file-drop-zone" onclick="document.getElementById('{{ homework_form.homework_file.id_for_label }}').click()">
                                    <div class="file-drop-content">
                                        <i class="fas fa-cloud-upload-alt fa-3x mb-3 text-muted"></i>
                                        <p class="mb-2">ç‚¹å‡»é€‰æ‹©æ–‡ä»¶æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„</p>
                                        <p class="text-muted small">æ”¯æŒï¼š.txt, .r, .R, .py, .md, .doc, .docx, .pdf</p>
                                        <p class="text-muted small">æœ€å¤§æ–‡ä»¶å¤§å°ï¼š10MB</p>
                                    </div>
                                </div>
                                {{ homework_form.homework_file }}
                            </div>
                            <div class="form-text text-muted mt-2">{{ homework_form.homework_file.help_text }}</div>
                            <div id="file-preview" class="file-preview mt-3" style="display: none;">
                                <div class="file-info-card">
                                    <i class="fas fa-file me-2"></i>
                                    <span id="file-name"></span>
                                    <span id="file-size" class="text-muted ms-2"></span>
                                    <button type="button" class="btn btn-sm btn-outline-danger ms-auto" onclick="clearFile()">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-flex gap-3">
                            <button type="submit" class="btn btn-pink">
                                <i class="fas fa-magic me-2"></i>ç”Ÿæˆè§£å†³æ–¹æ¡ˆ
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="clearForm('homework-form')">
                                <i class="fas fa-eraser me-2"></i>æ¸…ç©º
                            </button>
                        </div>
                    </form>

                    <div id="homework-loading" class="loading">
                        <div class="loading-spinner"></div>
                        <div class="loading-text">AIæ­£åœ¨ç”Ÿæˆè§£å†³æ–¹æ¡ˆ...</div>
                    </div>

                    <div id="homework-result" class="result-section"></div>
                </div>

                <!-- ä»£ç è§£é‡Šéƒ¨åˆ† -->
                <div id="explanation-section" class="content-section d-none">
                    <div class="page-header">
                        <h1 class="page-title">
                            <i class="fas fa-code"></i>
                            ä»£ç è§£é‡Š
                        </h1>
                        <p class="page-subtitle">ç²˜è´´æ‚¨çš„Rè¯­è¨€ä»£ç ï¼ŒAIå°†ç”¨é€šä¿—æ˜“æ‡‚çš„è¯­è¨€ä¸ºæ‚¨è§£é‡Š</p>
                    </div>

                    <form id="explanation-form" class="form-section">
                        {% csrf_token %}
                        
                        <!-- ä»£ç è¾“å…¥åŒºåŸŸ -->
                        <div class="form-group">
                            <label for="{{ explanation_form.r_code.id_for_label }}" class="form-label">
                                <i class="fas fa-file-code"></i>
                                {{ explanation_form.r_code.label }}
                                <div class="float-end">
                                    <small class="text-muted">
                                        <span id="dashboard-line-count">0 è¡Œ</span> | 
                                        <span id="dashboard-char-count">0 å­—ç¬¦</span>
                                    </small>
                                </div>
                            </label>
                            <div class="advanced-code-input-container">
                                <!-- é«˜çº§ä»£ç ç¼–è¾‘å™¨ -->
                                <div id="dashboard-code-editor"></div>
                                <div class="code-editor-toolbar">
                                    <div class="toolbar-section">
                                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearDashboardEditor()">
                                            <i class="fas fa-trash me-1"></i>æ¸…ç©º
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-info" onclick="toggleDashboardSymbolMode()">
                                            <i class="fas fa-font me-1"></i><span id="dashboard-symbol-text">ç¬¦å·</span>
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="formatDashboardCode()">
                                            <i class="fas fa-indent me-1"></i>æ ¼å¼åŒ–
                                        </button>
                                    </div>
                                    <div class="toolbar-section">
                                        <button type="button" class="btn btn-sm btn-outline-warning" onclick="toggleDashboardTheme()">
                                            <i class="fas fa-palette me-1"></i><span id="dashboard-theme-text">ä¸»é¢˜</span>
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-success" onclick="loadDashboardExample()">
                                            <i class="fas fa-code me-1"></i>ç¤ºä¾‹
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- éšè—çš„åŸå§‹textarea -->
                                <textarea name="r_code" id="{{ explanation_form.r_code.id_for_label }}" style="display: none;" required></textarea>
                                
                                <div class="selected-lines-info" id="dashboard-selected-lines-info" style="display: none;">
                                    <div class="alert alert-info alert-sm mb-0">
                                        <i class="fas fa-highlight me-2"></i>
                                        å·²é€‰æ‹© <strong><span id="dashboard-selected-lines-display">0</span></strong> è¡Œä»£ç ç”¨äºé‡ç‚¹è§£é‡Š
                                        <button type="button" class="btn btn-sm btn-outline-info ms-2" onclick="clearDashboardLineSelection()">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="form-text text-muted mt-2">{{ explanation_form.r_code.help_text }}</div>
                        </div>

                        <!-- ç”¨æˆ·æŸ¥è¯¢è¾“å…¥ -->
                        <div class="form-group">
                            <label for="{{ explanation_form.user_query.id_for_label }}" class="form-label">
                                <i class="fas fa-question-circle"></i>
                                {{ explanation_form.user_query.label }}
                            </label>
                            {{ explanation_form.user_query }}
                            <div class="form-text text-muted mt-2">{{ explanation_form.user_query.help_text }}</div>
                        </div>

                        <!-- éšè—å­—æ®µå­˜å‚¨é€‰ä¸­çš„è¡Œå· -->
                        {{ explanation_form.selected_lines }}
                        
                        <div class="d-flex gap-3">
                            <button type="submit" class="btn btn-pink">
                                <i class="fas fa-lightbulb me-2"></i>è§£é‡Šä»£ç 
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="clearExplanationForm()">
                                <i class="fas fa-eraser me-2"></i>æ¸…ç©º
                            </button>
                        </div>
                    </form>

                    <div id="explanation-loading" class="loading">
                        <div class="loading-spinner"></div>
                        <div class="loading-text">AIæ­£åœ¨åˆ†æä»£ç ...</div>
                    </div>

                    <div id="explanation-result" class="result-section"></div>
                </div>

                <!-- æ™ºèƒ½å¯¹è¯éƒ¨åˆ† -->
                <div id="chat-section" class="content-section d-none">
                    <div class="chat-container">
                        <!-- èŠå¤©å¤´éƒ¨ -->
                        <div class="chat-header">
                            <div class="chat-header-content">
                                <div class="ai-avatar">
                                    <i class="fas fa-robot"></i>
                                </div>
                                <div class="chat-info">
                                    <h3 class="chat-title">Rè¯­è¨€æ™ºèƒ½åŠ©æ‰‹</h3>
                                    <p class="chat-status online">
                                        <span class="status-dot"></span>
                                        åœ¨çº¿ - éšæ—¶ä¸ºæ‚¨è§£ç­”é—®é¢˜
                                    </p>
                                </div>
                                <div class="chat-actions">
                                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="clearChatHistory()">
                                        <i class="fas fa-trash me-1"></i>æ¸…ç©ºå¯¹è¯
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- èŠå¤©æ¶ˆæ¯åŒºåŸŸ -->
                        <div class="chat-messages" id="chat-messages">
                            <!-- æ¬¢è¿æ¶ˆæ¯ -->
                            <div class="message-group">
                                <div class="message ai-message">
                                    <div class="message-avatar">
                                        <i class="fas fa-robot"></i>
                                    </div>
                                    <div class="message-content">
                                        <div class="message-bubble">
                                            <div class="message-text">
                                                ğŸ‘‹ æ‚¨å¥½ï¼æˆ‘æ˜¯Rè¯­è¨€æ™ºèƒ½åŠ©æ‰‹ï¼Œå¾ˆé«˜å…´ä¸ºæ‚¨æœåŠ¡ï¼
                                                <br><br>
                                                æˆ‘å¯ä»¥å¸®åŠ©æ‚¨ï¼š
                                                <ul class="welcome-list">
                                                    <li>ğŸ“Š è§£ç­”Rè¯­è¨€ç¼–ç¨‹é—®é¢˜</li>
                                                    <li>ğŸ“ˆ æ•°æ®åˆ†æå’Œå¯è§†åŒ–æŒ‡å¯¼</li>
                                                    <li>ğŸ” ç»Ÿè®¡å­¦æ¦‚å¿µè§£é‡Š</li>
                                                    <li>ğŸ¯ å­¦ä¹ å»ºè®®å’Œæœ€ä½³å®è·µ</li>
                                                </ul>
                                                è¯·éšæ—¶å‘æˆ‘æé—®ï¼Œæˆ‘ä¼šå°½åŠ›ä¸ºæ‚¨æä¾›ä¸“ä¸šçš„å¸®åŠ©ï¼
                                            </div>
                                        </div>
                                        <div class="message-time">
                                            <i class="fas fa-clock me-1"></i>
                                            åˆšåˆš
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- æ‰“å­—æŒ‡ç¤ºå™¨ -->
                        <div id="typing-indicator" class="typing-indicator" style="display: none;">
                            <div class="message-group">
                                <div class="message ai-message">
                                    <div class="message-avatar">
                                        <i class="fas fa-robot"></i>
                                    </div>
                                    <div class="message-content">
                                        <div class="message-bubble typing">
                                            <div class="typing-dots">
                                                <span></span>
                                                <span></span>
                                                <span></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- è¾“å…¥åŒºåŸŸ -->
                        <div class="chat-input-area">
                            <form id="chat-form" class="chat-input-form">
                                {% csrf_token %}
                                <div class="input-container">
                                    <div class="input-group">
                                        <textarea 
                                            id="chat-message-input" 
                                            name="message"
                                            class="form-control chat-input" 
                                            placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜..."
                                            rows="1"
                                            maxlength="1000"
                                            required></textarea>
                                        <div class="input-actions">
                                            <button type="button" class="btn btn-ghost" title="è¡¨æƒ…">
                                                <i class="fas fa-smile"></i>
                                            </button>
                                            <button type="submit" class="btn btn-send" disabled>
                                                <i class="fas fa-paper-plane"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="input-footer">
                                        <small class="text-muted">
                                            <span id="char-count">0</span>/1000 å­—ç¬¦
                                            <span class="ms-3">æŒ‰ Enter å‘é€ï¼ŒShift + Enter æ¢è¡Œ</span>
                                        </small>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-r.min.js"></script>
    
    <script>
        // SPA å¯¼èˆªé€»è¾‘
        document.addEventListener('DOMContentLoaded', function() {
            const navLinks = document.querySelectorAll('.nav-link[data-section]');
            const sections = document.querySelectorAll('.content-section');
            
            // å¯¼èˆªåˆ‡æ¢
            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    const targetSection = this.dataset.section;
                    
                    // ç§»é™¤æ‰€æœ‰æ´»åŠ¨çŠ¶æ€
                    navLinks.forEach(l => l.classList.remove('active'));
                    sections.forEach(s => s.classList.add('d-none'));
                    
                    // æ·»åŠ æ´»åŠ¨çŠ¶æ€
                    this.classList.add('active');
                    document.getElementById(targetSection + '-section').classList.remove('d-none');
                    
                    // æ¸…é™¤ç»“æœ
                    clearResults();
                });
            });
            
            // è¡¨å•æäº¤å¤„ç†
            setupFormSubmissions();
        });
        
        // è¡¨å•æäº¤è®¾ç½®
        function setupFormSubmissions() {
            // è®¾ç½®æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½
            setupFileUpload();
            
            // è®¾ç½®èŠå¤©åŠŸèƒ½
            setupChatFeatures();
            
            // è®¾ç½®ä»£ç è¡Œé€‰æ‹©åŠŸèƒ½
            setupCodeLineSelection();
            
            // ä½œä¸šé¢˜è¡¨å•
            document.getElementById('homework-form').addEventListener('submit', function(e) {
                e.preventDefault();
                submitForm('homework', this);
            });
            
            // ä»£ç è§£é‡Šè¡¨å•
            document.getElementById('explanation-form').addEventListener('submit', function(e) {
                e.preventDefault();
                submitForm('explanation', this);
            });
            
            // æ³¨æ„ï¼šèŠå¤©è¡¨å•ç°åœ¨ç”±setupChatFeatures()å¤„ç†
        }
        
        // é€šç”¨è¡¨å•æäº¤
        function submitForm(type, form) {
            const formData = new FormData(form);
            const loadingElement = document.getElementById(type + '-loading');
            const resultElement = document.getElementById(type + '-result');
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            loadingElement.style.display = 'block';
            resultElement.style.display = 'none';
            
            // æ ¹æ®ç±»å‹è®¾ç½®URL
            let url;
            switch(type) {
                case 'homework':
                    url = '{% url "rcode_helper:homework_solution" %}';
                    break;
                case 'explanation':
                    url = '{% url "rcode_helper:code_explanation" %}';
                    break;
                case 'chat':
                    url = '{% url "rcode_helper:chat" %}';
                    break;
            }
            
            // æäº¤è¯·æ±‚
            fetch(url, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                if (response.redirected) {
                    // å¦‚æœé‡å®šå‘åˆ°ç»“æœé¡µé¢ï¼ŒåŠ è½½ç»“æœ
                    return fetch(response.url).then(r => r.text());
                }
                return response.text();
            })
            .then(html => {
                // éšè—åŠ è½½çŠ¶æ€
                loadingElement.style.display = 'none';
                
                // æ˜¾ç¤ºç»“æœ
                resultElement.innerHTML = html;
                resultElement.style.display = 'block';
                
                // é«˜äº®ä»£ç 
                if (typeof Prism !== 'undefined') {
                    Prism.highlightAll();
                }
                
                // æ»šåŠ¨åˆ°ç»“æœ
                resultElement.scrollIntoView({ behavior: 'smooth' });
            })
            .catch(error => {
                console.error('Error:', error);
                loadingElement.style.display = 'none';
                resultElement.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        è¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•
                    </div>
                `;
                resultElement.style.display = 'block';
            });
        }
        
        // æ¸…ç©ºè¡¨å•
        function clearForm(formId) {
            const form = document.getElementById(formId);
            form.reset();
            
            // æ¸…ç©ºå¯¹åº”çš„ç»“æœ
            const type = formId.replace('-form', '');
            clearResult(type);
        }
        
        // æ¸…ç©ºå•ä¸ªç»“æœ
        function clearResult(type) {
            const resultElement = document.getElementById(type + '-result');
            if (resultElement) {
                resultElement.innerHTML = '';
                resultElement.style.display = 'none';
            }
        }
        
        // æ¸…ç©ºæ‰€æœ‰ç»“æœ
        function clearResults() {
            ['homework', 'explanation', 'chat'].forEach(type => {
                clearResult(type);
                const loadingElement = document.getElementById(type + '-loading');
                if (loadingElement) {
                    loadingElement.style.display = 'none';
                }
            });
        }
        
        // ç§»åŠ¨ç«¯èœå•åˆ‡æ¢
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            sidebar.classList.toggle('active');
        }

        // ========== æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½ ==========

        // è®¾ç½®æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½
        function setupFileUpload() {
            const fileInput = document.getElementById('homework_file_input');
            const fileDropZone = document.querySelector('.file-drop-zone');
            const filePreview = document.getElementById('file-preview');

            if (!fileInput || !fileDropZone || !filePreview) {
                return; // å¦‚æœå…ƒç´ ä¸å­˜åœ¨ï¼Œç›´æ¥è¿”å›
            }

            // æ–‡ä»¶é€‰æ‹©äº‹ä»¶
            fileInput.addEventListener('change', handleFileSelect);

            // æ‹–æ‹½åŠŸèƒ½
            fileDropZone.addEventListener('dragover', handleDragOver);
            fileDropZone.addEventListener('dragenter', handleDragEnter);
            fileDropZone.addEventListener('dragleave', handleDragLeave);
            fileDropZone.addEventListener('drop', handleFileDrop);
        }

        // è¾“å…¥æ–¹å¼åˆ‡æ¢
        function toggleInputMethod() {
            const textInput = document.getElementById('text-input-area');
            const fileInput = document.getElementById('file-input-area');
            const inputMethod = document.querySelector('input[name="input_method"]:checked').value;
            
            if (inputMethod === 'text') {
                textInput.style.display = 'block';
                fileInput.style.display = 'none';
                // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©
                clearFile();
            } else {
                textInput.style.display = 'none';
                fileInput.style.display = 'block';
                // æ¸…ç©ºæ–‡æœ¬è¾“å…¥
                document.getElementById('homework_text_input').value = '';
            }
        }

        // å¤„ç†æ–‡ä»¶é€‰æ‹©
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                showFilePreview(file);
                validateFile(file);
            }
        }

        // å¤„ç†æ‹–æ‹½æ‚¬åœ
        function handleDragOver(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'copy';
        }

        // å¤„ç†æ‹–æ‹½è¿›å…¥
        function handleDragEnter(event) {
            event.preventDefault();
            event.target.closest('.file-drop-zone').classList.add('dragover');
        }

        // å¤„ç†æ‹–æ‹½ç¦»å¼€
        function handleDragLeave(event) {
            event.preventDefault();
            const rect = event.target.getBoundingClientRect();
            const x = event.clientX;
            const y = event.clientY;
            
            // åªæœ‰å½“é¼ æ ‡çœŸæ­£ç¦»å¼€åŒºåŸŸæ—¶æ‰ç§»é™¤æ ·å¼
            if (x < rect.left || x > rect.right || y < rect.top || y > rect.bottom) {
                event.target.closest('.file-drop-zone').classList.remove('dragover');
            }
        }

        // å¤„ç†æ–‡ä»¶æ‹–æ‹½æ”¾ç½®
        function handleFileDrop(event) {
            event.preventDefault();
            event.target.classList.remove('dragover');
            
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                const fileInput = document.getElementById('homework_file_input');
                fileInput.files = files;
                
                // è§¦å‘changeäº‹ä»¶
                const changeEvent = new Event('change', { bubbles: true });
                fileInput.dispatchEvent(changeEvent);
            }
        }

        // æ˜¾ç¤ºæ–‡ä»¶é¢„è§ˆ
        function showFilePreview(file) {
            const filePreview = document.getElementById('file-preview');
            const fileName = document.getElementById('file-name');
            const fileSize = document.getElementById('file-size');
            
            fileName.textContent = file.name;
            fileSize.textContent = `(${formatFileSize(file.size)})`;
            filePreview.style.display = 'block';
        }

        // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©
        function clearFile() {
            const fileInput = document.getElementById('homework_file_input');
            const filePreview = document.getElementById('file-preview');
            
            if (fileInput) {
                fileInput.value = '';
            }
            if (filePreview) {
                filePreview.style.display = 'none';
            }
        }

        // è®¾ç½®ä»£ç è¡Œé€‰æ‹©åŠŸèƒ½
        let selectedLines = new Set();
        
        function setupCodeLineSelection() {
            const codeInput = document.getElementById('r_code_input');
            const lineNumbers = document.getElementById('code-line-numbers');
            const selectedLinesInfo = document.getElementById('selected-lines-info');
            const selectedLinesDisplay = document.getElementById('selected-lines-display');
            const selectedLinesInput = document.getElementById('selected_lines_input');
            
            if (!codeInput || !lineNumbers) {
                return;
            }
            
            // ç›‘å¬ä»£ç è¾“å…¥å˜åŒ–
            codeInput.addEventListener('input', updateLineNumbers);
            
            // æ·»åŠ æ»šåŠ¨ç›‘å¬å™¨ï¼Œä½¿ç”¨ requestAnimationFrame æ¥ä¼˜åŒ–æ€§èƒ½
            let scrollTicking = false;
            codeInput.addEventListener('scroll', function() {
                if (!scrollTicking) {
                    requestAnimationFrame(function() {
                        syncLineNumbersScroll();
                        scrollTicking = false;
                    });
                    scrollTicking = true;
                }
            });
            
            // æ·»åŠ çª—å£å¤§å°å˜åŒ–ç›‘å¬ï¼Œç¡®ä¿å¸ƒå±€æ­£ç¡®
            window.addEventListener('resize', function() {
                setTimeout(syncLineNumbersScroll, 100);
            });
            
            // åˆå§‹åŒ–è¡Œå·
            updateLineNumbers();
        }
        
        function updateLineNumbers() {
            const codeInput = document.getElementById('r_code_input');
            const lineNumbers = document.getElementById('code-line-numbers');
            
            if (!codeInput || !lineNumbers) return;
            
            const lines = codeInput.value.split('\n');
            const lineCount = Math.max(lines.length, 10); // è‡³å°‘æ˜¾ç¤º10è¡Œ
            
            let numbersHtml = '';
            for (let i = 1; i <= lineCount; i++) {
                const isSelected = selectedLines.has(i);
                numbersHtml += `<span class="line-number ${isSelected ? 'selected' : ''}" 
                    data-line="${i}" onclick="toggleLineSelection(${i})">${i}</span>`;
            }
            
            // åˆ›å»ºå†…éƒ¨å®¹å™¨æ¥å®ç°æ»šåŠ¨
            lineNumbers.innerHTML = `<div class="line-numbers-content">${numbersHtml}</div>`;
        }
        
        function syncLineNumbersScroll() {
            const codeInput = document.getElementById('r_code_input');
            const lineNumbers = document.getElementById('code-line-numbers');
            
            if (!codeInput || !lineNumbers) return;
            
            const lineNumbersContent = lineNumbers.querySelector('.line-numbers-content');
            if (!lineNumbersContent) return;
            
            // è·å–æ»šåŠ¨ä½ç½®
            const scrollTop = codeInput.scrollTop;
            
            // åº”ç”¨æ»šåŠ¨å˜æ¢
            lineNumbersContent.style.transform = `translateY(-${scrollTop}px)`;
        }
        
        function toggleLineSelection(lineNumber) {
            if (selectedLines.has(lineNumber)) {
                selectedLines.delete(lineNumber);
            } else {
                selectedLines.add(lineNumber);
            }
            
            updateLineNumbers();
            updateSelectedLinesDisplay();
        }
        
        function updateSelectedLinesDisplay() {
            const selectedLinesInfo = document.getElementById('selected-lines-info');
            const selectedLinesDisplay = document.getElementById('selected-lines-display');
            const selectedLinesInput = document.getElementById('selected_lines_input');
            
            if (!selectedLinesInfo || !selectedLinesDisplay || !selectedLinesInput) return;
            
            if (selectedLines.size > 0) {
                const sortedLines = Array.from(selectedLines).sort((a, b) => a - b);
                selectedLinesDisplay.textContent = sortedLines.join(', ');
                selectedLinesInput.value = JSON.stringify(sortedLines);
                selectedLinesInfo.style.display = 'block';
            } else {
                selectedLinesInfo.style.display = 'none';
                selectedLinesInput.value = '';
            }
        }
        
        function clearLineSelection() {
            selectedLines.clear();
            updateLineNumbers();
            updateSelectedLinesDisplay();
        }
        
        // ä¿®æ”¹æ¸…ç©ºè¡¨å•å‡½æ•°ä»¥æ”¯æŒä»£ç è§£é‡Šè¡¨å•
        function clearExplanationForm() {
            const form = document.getElementById('explanation-form');
            form.reset();
            clearLineSelection();
            clearResult('explanation');
        }

        // éªŒè¯æ–‡ä»¶
        function validateFile(file) {
            const maxSize = 10 * 1024 * 1024; // 10MB
            const allowedTypes = ['.txt', '.r', '.R', '.py', '.md', '.doc', '.docx', '.pdf'];
            
            // æ£€æŸ¥æ–‡ä»¶å¤§å°
            if (file.size > maxSize) {
                alert('æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡10MB');
                clearFile();
                return false;
            }
            
            // æ£€æŸ¥æ–‡ä»¶ç±»å‹
            const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
            if (!allowedTypes.includes(fileExtension) && !allowedTypes.includes(fileExtension.toUpperCase())) {
                alert('ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼ã€‚æ”¯æŒçš„æ ¼å¼ï¼š' + allowedTypes.join(', '));
                clearFile();
                return false;
            }
            
            return true;
        }

        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // ========== èŠå¤©åŠŸèƒ½ ==========

        // åˆå§‹åŒ–èŠå¤©åŠŸèƒ½
        function setupChatFeatures() {
            const chatInput = document.getElementById('chat-message-input');
            const chatForm = document.getElementById('chat-form');
            const sendButton = document.querySelector('.btn-send');
            const charCount = document.getElementById('char-count');

            if (!chatInput || !chatForm) return;

            // ç›‘å¬è¾“å…¥å˜åŒ–
            chatInput.addEventListener('input', function() {
                const length = this.value.length;
                charCount.textContent = length;
                
                // æ§åˆ¶å‘é€æŒ‰é’®çŠ¶æ€
                sendButton.disabled = length === 0;
                
                // è‡ªåŠ¨è°ƒæ•´é«˜åº¦
                autoResizeTextarea(this);
            });

            // é”®ç›˜äº‹ä»¶å¤„ç†
            chatInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    if (this.value.trim()) {
                        chatForm.dispatchEvent(new Event('submit'));
                    }
                }
            });

            // è¡¨å•æäº¤
            chatForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const message = chatInput.value.trim();
                if (message) {
                    sendChatMessage(message);
                    chatInput.value = '';
                    chatInput.dispatchEvent(new Event('input'));
                }
            });
        }

        // è‡ªåŠ¨è°ƒæ•´æ–‡æœ¬æ¡†é«˜åº¦
        function autoResizeTextarea(textarea) {
            textarea.style.height = 'auto';
            const newHeight = Math.min(textarea.scrollHeight, 120);
            textarea.style.height = newHeight + 'px';
        }

        // å‘é€èŠå¤©æ¶ˆæ¯
        function sendChatMessage(message) {
            const sendButton = document.querySelector('.btn-send');
            
            // æ·»åŠ å‘é€åŠ¨ç”»
            sendButton.classList.add('sending');
            sendButton.disabled = true;
            
            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°ç•Œé¢
            addMessageToChat(message, 'user');
            
            // æ˜¾ç¤ºæ‰“å­—æŒ‡ç¤ºå™¨
            showTypingIndicator();
            
            // å‡†å¤‡è¡¨å•æ•°æ®
            const formData = new FormData();
            formData.append('message', message);
            formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
            
            // å‘é€è¯·æ±‚
            fetch('{% url "rcode_helper:chat" %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                hideTypingIndicator();
                
                // ç§»é™¤å‘é€åŠ¨ç”»
                sendButton.classList.remove('sending');
                sendButton.disabled = false;
                
                if (data.error) {
                    addMessageToChat('æŠ±æ­‰ï¼Œå¤„ç†æ‚¨çš„æ¶ˆæ¯æ—¶å‡ºç°äº†é”™è¯¯ã€‚è¯·ç¨åé‡è¯•ã€‚', 'ai', true);
                } else {
                    // å»¶è¿Ÿæ˜¾ç¤ºAIå›å¤ï¼Œæ¨¡æ‹ŸçœŸå®å¯¹è¯
                    setTimeout(() => {
                        addMessageToChat(data.ai_response || data.response, 'ai');
                        
                        // æ’­æ”¾æç¤ºéŸ³æ•ˆï¼ˆå¯é€‰ï¼‰
                        playNotificationSound();
                    }, 500);
                }
            })
            .catch(error => {
                console.error('Chat error:', error);
                hideTypingIndicator();
                
                // ç§»é™¤å‘é€åŠ¨ç”»
                sendButton.classList.remove('sending');
                sendButton.disabled = false;
                
                addMessageToChat('ç½‘ç»œè¿æ¥å‡ºç°é—®é¢˜ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•ã€‚', 'ai', true);
            });
        }

        // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©ç•Œé¢
        function addMessageToChat(message, sender, isError = false) {
            const chatMessages = document.getElementById('chat-messages');
            const messageGroup = document.createElement('div');
            messageGroup.className = 'message-group';
            
            const currentTime = new Date().toLocaleTimeString('zh-CN', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            const isUser = sender === 'user';
            const avatarIcon = isUser ? 'fas fa-user' : 'fas fa-robot';
            
            messageGroup.innerHTML = `
                <div class="message ${isUser ? 'user-message' : 'ai-message'}">
                    <div class="message-avatar">
                        <i class="${avatarIcon}"></i>
                    </div>
                    <div class="message-content">
                        <div class="message-bubble ${isError ? 'error' : ''}">
                            <div class="message-text">${formatMessageText(message)}</div>
                        </div>
                        <div class="message-time">
                            <i class="fas fa-clock me-1"></i>
                            ${currentTime}
                        </div>
                    </div>
                </div>
            `;
            
            // æ·»åŠ åˆ°èŠå¤©åŒºåŸŸ
            chatMessages.appendChild(messageGroup);
            
            // å¹³æ»‘æ»šåŠ¨åˆ°åº•éƒ¨
            scrollToBottom();
            
            // é«˜äº®ä»£ç 
            if (typeof Prism !== 'undefined') {
                Prism.highlightAll();
            }
        }

        // å¹³æ»‘æ»šåŠ¨åˆ°åº•éƒ¨
        function scrollToBottom() {
            const chatMessages = document.getElementById('chat-messages');
            const scrollTarget = chatMessages.scrollHeight - chatMessages.clientHeight;
            
            // ä½¿ç”¨åŠ¨ç”»æ»šåŠ¨
            const startTime = performance.now();
            const startScroll = chatMessages.scrollTop;
            const distance = scrollTarget - startScroll;
            const duration = 300;
            
            function scrollAnimation(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                // ä½¿ç”¨easeOutCubicç¼“åŠ¨å‡½æ•°
                const easeProgress = 1 - Math.pow(1 - progress, 3);
                
                chatMessages.scrollTop = startScroll + distance * easeProgress;
                
                if (progress < 1) {
                    requestAnimationFrame(scrollAnimation);
                }
            }
            
            requestAnimationFrame(scrollAnimation);
        }

        // æ ¼å¼åŒ–æ¶ˆæ¯æ–‡æœ¬ï¼ˆå¢å¼ºç‰ˆï¼‰
        function formatMessageText(text) {
            if (!text) return '';
            
            // è½¬æ¢æ¢è¡Œç¬¦ä¸º<br>
            text = text.replace(/\n/g, '<br>');
            
            // ä»£ç å—é«˜äº®
            text = text.replace(/```(\w+)?\n?([\s\S]*?)```/g, (match, lang, code) => {
                const language = lang || 'r';
                return `<pre><code class="language-${language}">${code.trim()}</code></pre>`;
            });
            
            // è¡Œå†…ä»£ç 
            text = text.replace(/`([^`]+)`/g, '<code class="inline-code">$1</code>');
            
            // é“¾æ¥æ£€æµ‹
            text = text.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" rel="noopener">$1</a>');
            
            // è¡¨æƒ…ç¬¦å·æ”¯æŒ
            text = text.replace(/:\)/g, 'ğŸ˜Š');
            text = text.replace(/:\(/g, 'ğŸ˜¢');
            text = text.replace(/:D/g, 'ğŸ˜„');
            text = text.replace(/;\)/g, 'ğŸ˜‰');
            
            return text;
        }

        // æ’­æ”¾æç¤ºéŸ³æ•ˆ
        function playNotificationSound() {
            // åˆ›å»ºéŸ³é¢‘ä¸Šä¸‹æ–‡ï¼ˆWeb Audio APIï¼‰
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                // è®¾ç½®é¢‘ç‡å’ŒéŸ³é‡
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
            } catch (e) {
                // å¦‚æœéŸ³é¢‘ä¸æ”¯æŒï¼Œé™é»˜å¤±è´¥
                console.log('Audio notification not supported');
            }
        }

        // æ˜¾ç¤ºæ‰“å­—æŒ‡ç¤ºå™¨ï¼ˆå¢å¼ºç‰ˆï¼‰
        function showTypingIndicator() {
            const typingIndicator = document.getElementById('typing-indicator');
            
            typingIndicator.style.display = 'block';
            scrollToBottom();
            
            // éšæœºå»¶è¿Ÿï¼Œè®©AIæ˜¾å¾—æ›´"äººæ€§åŒ–"
            const randomDelay = 1000 + Math.random() * 2000; // 1-3ç§’éšæœºå»¶è¿Ÿ
            
            return new Promise(resolve => {
                setTimeout(resolve, randomDelay);
            });
        }

        // æ¸…ç©ºèŠå¤©è®°å½•ï¼ˆå¢å¼ºç‰ˆï¼‰
        function clearChatHistory() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰èŠå¤©è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
                const chatMessages = document.getElementById('chat-messages');
                
                // æ·»åŠ æ¸…ç©ºåŠ¨ç”»
                chatMessages.style.opacity = '0';
                chatMessages.style.transform = 'scale(0.95)';
                
                setTimeout(() => {
                    // åªä¿ç•™æ¬¢è¿æ¶ˆæ¯
                    const welcomeMessage = chatMessages.querySelector('.message-group');
                    chatMessages.innerHTML = '';
                    if (welcomeMessage) {
                        chatMessages.appendChild(welcomeMessage);
                    }
                    
                    // æ¢å¤æ ·å¼
                    chatMessages.style.opacity = '1';
                    chatMessages.style.transform = 'scale(1)';
                    
                    // æ˜¾ç¤ºæ¸…ç©ºæç¤º
                    setTimeout(() => {
                        addMessageToChat('èŠå¤©è®°å½•å·²æ¸…ç©ºï¼Œè®©æˆ‘ä»¬é‡æ–°å¼€å§‹å§ï¼ ğŸ˜Š', 'ai');
                    }, 500);
                }, 300);
            }
        }

        // æ™ºèƒ½å»ºè®®åŠŸèƒ½
        function showQuickSuggestions() {
            const suggestions = [
                "Rè¯­è¨€åŸºç¡€è¯­æ³•æœ‰å“ªäº›ï¼Ÿ",
                "å¦‚ä½•è¿›è¡Œæ•°æ®å¯è§†åŒ–ï¼Ÿ",
                "ä»€ä¹ˆæ˜¯çº¿æ€§å›å½’åˆ†æï¼Ÿ",
                "å¦‚ä½•å¤„ç†ç¼ºå¤±æ•°æ®ï¼Ÿ",
                "Rä¸­çš„å¾ªç¯ç»“æ„æ€ä¹ˆå†™ï¼Ÿ"
            ];
            
            // TODO: å¯ä»¥åœ¨ç•Œé¢ä¸­æ˜¾ç¤ºè¿™äº›å»ºè®®æŒ‰é’®
            return suggestions;
        }

        // ====== Dashboard é«˜çº§ä»£ç ç¼–è¾‘å™¨åŠŸèƒ½ ======
        let dashboardEditor = null;
        let dashboardCurrentTheme = 'vs-dark';
        let dashboardSymbolMode = false;

        // åˆå§‹åŒ–Dashboardç¼–è¾‘å™¨
        async function initializeDashboardEditor() {
            try {
                // ç¡®ä¿AdvancedCodeEditorç±»å¯ç”¨
                if (typeof AdvancedCodeEditor === 'undefined') {
                    console.warn('AdvancedCodeEditoræœªåŠ è½½ï¼Œä½¿ç”¨åŸºç¡€ç¼–è¾‘å™¨');
                    return;
                }

                dashboardEditor = new AdvancedCodeEditor('#dashboard-code-editor', {
                    language: 'r',
                    theme: dashboardCurrentTheme,
                    lineNumbers: true,
                    wordWrap: false,
                    minimap: false,
                    fontSize: 14,
                    height: 300,
                    scrollBeyondLastLine: false,
                    automaticLayout: true,
                    renderWhitespace: 'selection',
                    renderControlCharacters: false,
                    enableSymbolReplacement: false
                });

                // ç›‘å¬å†…å®¹å˜åŒ–
                dashboardEditor.container.addEventListener('contentChange', function(e) {
                    const content = e.detail.content;
                    const hiddenTextarea = document.getElementById('{{ explanation_form.r_code.id_for_label }}');
                    if (hiddenTextarea) {
                        hiddenTextarea.value = content;
                    }
                    updateDashboardEditorStats();
                });

                // ç›‘å¬é€‰æ‹©å˜åŒ–
                dashboardEditor.container.addEventListener('selectionChange', function(e) {
                    updateDashboardSelectedLinesInfo();
                });

                updateDashboardEditorStats();

            } catch (error) {
                console.warn('Dashboardç¼–è¾‘å™¨åˆå§‹åŒ–å¤±è´¥:', error);
            }
        }

        function updateDashboardEditorStats() {
            if (!dashboardEditor) return;

            const content = dashboardEditor.getValue();
            const lines = content.split('\n').length;
            const chars = content.length;

            const lineCountEl = document.getElementById('dashboard-line-count');
            const charCountEl = document.getElementById('dashboard-char-count');
            
            if (lineCountEl) lineCountEl.textContent = `${lines} è¡Œ`;
            if (charCountEl) charCountEl.textContent = `${chars} å­—ç¬¦`;
        }

        function updateDashboardSelectedLinesInfo() {
            if (!dashboardEditor) return;

            const selectedLines = dashboardEditor.getSelectedLines();
            const count = selectedLines.length;

            const displayEl = document.getElementById('dashboard-selected-lines-display');
            const infoDiv = document.getElementById('dashboard-selected-lines-info');
            const selectedLinesInput = document.querySelector('input[name="selected_lines"]');

            if (displayEl) displayEl.textContent = count;

            if (count > 0) {
                if (infoDiv) infoDiv.style.display = 'block';
                if (selectedLinesInput) selectedLinesInput.value = selectedLines.join(',');
            } else {
                if (infoDiv) infoDiv.style.display = 'none';
                if (selectedLinesInput) selectedLinesInput.value = '';
            }
        }

        function clearDashboardEditor() {
            if (dashboardEditor) {
                dashboardEditor.setValue('');
                dashboardEditor.clearSelection();
                showDashboardNotification('ç¼–è¾‘å™¨å·²æ¸…ç©º', 'info');
            }
        }

        function toggleDashboardSymbolMode() {
            dashboardSymbolMode = !dashboardSymbolMode;
            const symbolText = document.getElementById('dashboard-symbol-text');
            const btn = symbolText?.parentElement;

            if (dashboardSymbolMode) {
                if (symbolText) symbolText.textContent = 'æ ‡å‡†';
                if (btn) {
                    btn.classList.remove('btn-outline-info');
                    btn.classList.add('btn-info');
                }
                showDashboardNotification('ç¬¦å·æ¨¡å¼å·²å¯ç”¨', 'info');
            } else {
                if (symbolText) symbolText.textContent = 'ç¬¦å·';
                if (btn) {
                    btn.classList.remove('btn-info');
                    btn.classList.add('btn-outline-info');
                }
                showDashboardNotification('æ ‡å‡†æ¨¡å¼å·²å¯ç”¨', 'info');
            }

            if (dashboardEditor && dashboardEditor.options) {
                dashboardEditor.options.enableSymbolReplacement = dashboardSymbolMode;
            }
        }

        function formatDashboardCode() {
            if (dashboardEditor) {
                dashboardEditor.formatCode();
                showDashboardNotification('ä»£ç å·²æ ¼å¼åŒ–', 'success');
            }
        }

        function toggleDashboardTheme() {
            dashboardCurrentTheme = dashboardCurrentTheme === 'vs-dark' ? 'vs' : 'vs-dark';
            const themeText = document.getElementById('dashboard-theme-text');

            if (dashboardCurrentTheme === 'vs-dark') {
                if (themeText) themeText.textContent = 'æ·±è‰²';
                if (dashboardEditor && dashboardEditor.editor) {
                    monaco.editor.setTheme('vs-dark');
                }
            } else {
                if (themeText) themeText.textContent = 'æµ…è‰²';
                if (dashboardEditor && dashboardEditor.editor) {
                    monaco.editor.setTheme('vs');
                }
            }
        }

        function loadDashboardExample() {
            const exampleCode = `# Rè¯­è¨€æ•°æ®åˆ†æå…¥é—¨ç¤ºä¾‹
# ä½œè€…ï¼šRè¯­è¨€åŠ©æ‰‹
# æ—¶é—´ï¼š${new Date().toLocaleDateString()}

# 1. åŠ è½½å¿…è¦çš„åŒ…
library(ggplot2)
library(dplyr)

# 2. åˆ›å»ºç¤ºä¾‹æ•°æ®
students <- data.frame(
    name = c("å¼ ä¸‰", "æå››", "ç‹äº”", "èµµå…­", "å­™ä¸ƒ"),
    math_score = c(85, 92, 78, 96, 88),
    english_score = c(90, 85, 92, 89, 94),
    age = c(20, 21, 19, 22, 20)
)

# 3. æ•°æ®æ¢ç´¢
print("=== æ•°æ®æ¦‚è§ˆ ===")
head(students)
summary(students)

# 4. æ•°æ®åˆ†æ
print("=== åˆ†æç»“æœ ===")
# è®¡ç®—å¹³å‡åˆ†
students$average_score <- (students$math_score + students$english_score) / 2

# æ‰¾å‡ºæˆç»©æœ€å¥½çš„å­¦ç”Ÿ
best_student <- students[which.max(students$average_score), ]
print(paste("æˆç»©æœ€å¥½çš„å­¦ç”Ÿæ˜¯:", best_student$name))

# 5. æ•°æ®å¯è§†åŒ–
# åˆ›å»ºæ•£ç‚¹å›¾
ggplot(students, aes(x = math_score, y = english_score)) +
    geom_point(aes(color = name), size = 3) +
    geom_smooth(method = "lm", se = FALSE, color = "red") +
    labs(title = "æ•°å­¦æˆç»©ä¸è‹±è¯­æˆç»©çš„å…³ç³»",
         x = "æ•°å­¦æˆç»©", 
         y = "è‹±è¯­æˆç»©") +
    theme_minimal()

print("ç¤ºä¾‹ä»£ç æ‰§è¡Œå®Œæˆï¼")`;

            if (dashboardEditor) {
                dashboardEditor.setValue(exampleCode);
                showDashboardNotification('ç¤ºä¾‹ä»£ç å·²åŠ è½½', 'success');
            }
        }

        function clearDashboardLineSelection() {
            if (dashboardEditor) {
                dashboardEditor.clearSelection();
                updateDashboardSelectedLinesInfo();
                showDashboardNotification('å·²æ¸…é™¤è¡Œé€‰æ‹©', 'info');
            }
        }

        function showDashboardNotification(message, type = 'info') {
            // åˆ›å»ºé€šçŸ¥å…ƒç´ 
            const notification = document.createElement('div');
            notification.className = `alert alert-${type === 'error' ? 'danger' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info'} dashboard-notification`;
            notification.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="fas fa-${type === 'error' ? 'exclamation-triangle' : type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-circle' : 'info-circle'} me-2"></i>
                    ${message}
                </div>
            `;

            // æ·»åŠ æ ·å¼
            notification.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                z-index: 9999;
                min-width: 250px;
                animation: slideInRight 0.3s ease;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                border: none;
                border-radius: 8px;
            `;

            document.body.appendChild(notification);

            // è‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–Dashboardç¼–è¾‘å™¨
        document.addEventListener('DOMContentLoaded', function() {
            // å»¶è¿Ÿåˆå§‹åŒ–ï¼Œç¡®ä¿æ‰€æœ‰èµ„æºéƒ½å·²åŠ è½½
            setTimeout(() => {
                initializeDashboardEditor();
            }, 1000);
        });
    </script>
    
    <!-- é«˜çº§ä»£ç ç¼–è¾‘å™¨èµ„æº -->
    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@latest/min/vs/loader.js"></script>
    <!-- é«˜çº§ä»£ç ç¼–è¾‘å™¨æ¨¡å—åŒ–è·¯å¾„ -->
    <link rel="stylesheet" href="{% static 'css/components/advanced-code-editor.css' %}">
    <script src="{% static 'js/modules/advanced-code-editor.js' %}"></script>
    
    <!-- Dashboardç¼–è¾‘å™¨æ ·å¼ -->
    <style>
    .advanced-code-input-container {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        overflow: hidden;
        background: #f8f9fa;
    }
    
    .advanced-code-input-container #dashboard-code-editor {
        height: 300px;
        border: none;
    }
    
    .code-editor-toolbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 12px;
        background: #e9ecef;
        border-top: 1px solid #dee2e6;
        flex-wrap: wrap;
        gap: 8px;
    }
    
    .toolbar-section {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
    }
    
    .dashboard-notification {
        font-size: 14px;
    }
    
    /* å“åº”å¼ä¼˜åŒ– */
    @media (max-width: 768px) {
        .advanced-code-input-container #dashboard-code-editor {
            height: 250px;
        }
        
        .code-editor-toolbar {
            flex-direction: column;
            align-items: stretch;
        }
        
        .toolbar-section {
            justify-content: center;
        }
    }
    </style>
    </script>
    
    <!-- ä¸»é¢˜ç³»ç»Ÿè„šæœ¬ -->
    <!-- ä¸»é¢˜è„šæœ¬æ–°è·¯å¾„ -->
    <script src="{% static 'js/lib/themes.js' %}"></script>
</body>
</html>