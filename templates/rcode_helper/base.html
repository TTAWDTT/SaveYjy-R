<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, maximum-scale=5.0">
    <meta name="description" content="ä¸“ä¸šçš„Rè¯­è¨€æ™ºèƒ½åŠ©æ‰‹ï¼Œæä¾›ä»£ç è§£é‡Šã€ä½œä¸šè¾…å¯¼ã€æ™ºèƒ½é—®ç­”ç­‰æœåŠ¡">
    <meta name="keywords" content="Rè¯­è¨€,æ•°æ®åˆ†æ,ç»Ÿè®¡å­¦,ä»£ç è§£é‡Š,ç¼–ç¨‹åŠ©æ‰‹">
    <meta name="author" content="Rè¯­è¨€åŠ©æ‰‹å›¢é˜Ÿ">
    
    <!-- æ€§èƒ½å’ŒSEOä¼˜åŒ– -->
    <meta name="robots" content="index, follow">
    <meta name="theme-color" content="#667eea">
    <link rel="canonical" href="{{ request.build_absolute_uri }}">
    
    <title>{% block title %}Rè¯­è¨€åŠ©æ‰‹ - ä¸“ä¸šçš„Rè¯­è¨€å­¦ä¹ ä¸å¼€å‘å·¥å…·{% endblock %}</title>
    
    <!-- é¢„è¿æ¥å’ŒDNSé¢„å– -->
    <link rel="dns-prefetch" href="//cdn.jsdelivr.net">
    <link rel="dns-prefetch" href="//cdnjs.cloudflare.com">
    <link rel="dns-prefetch" href="//fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    <!-- æ ¸å¿ƒCSSæ¡†æ¶ -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    
    <!-- ä»£ç é«˜äº® -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-dark.min.css" rel="stylesheet" media="(prefers-color-scheme: dark)">
    
    
    
    <!-- ä»£ç å­—ä½“ -->
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300;400;500;600&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- è‡ªå®šä¹‰æ ·å¼ -->
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <link rel="stylesheet" href="{% static 'css/enhanced-ui.css' %}">
    <link rel="stylesheet" href="{% static 'css/themes.css' %}">
    <link rel="stylesheet" href="{% static 'css/icon-fix.css' %}">
    
    <!-- å“åº”å¼å’Œæ— éšœç¢å¢å¼º -->
    <style>
        /* åŸºç¡€å“åº”å¼é‡ç½® */
        * {
            box-sizing: border-box;
        }
        
        html {
            font-size: 16px;
            scroll-behavior: smooth;
        }
        
        body {
            font-family: 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji', 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', 'SimHei', Roboto, sans-serif;
            line-height: 1.6;
            color: #2d3748;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* å“åº”å¼å­—ä½“ç¼©æ”¾ */
        @media (max-width: 480px) {
            html { font-size: 14px; }
        }
        
        @media (min-width: 1200px) {
            html { font-size: 18px; }
        }
        
        /* Emojiæ˜¾ç¤ºä¼˜åŒ– */
        .emoji, span[class*="emoji"], .theme-emoji {
            font-family: 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji', sans-serif !important;
            font-variant-emoji: emoji !important;
            font-style: normal !important;
            font-weight: normal !important;
            line-height: 1 !important;
            text-rendering: optimizeLegibility !important;
            -webkit-font-smoothing: antialiased !important;
            -moz-osx-font-smoothing: grayscale !important;
        }
        
        /* ç„¦ç‚¹æ ·å¼ä¼˜åŒ– */
        *:focus {
            outline: 2px solid #667eea;
            outline-offset: 2px;
        }
        
        /* æ”¹è¿›çš„è·³è¿‡é“¾æ¥ */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 6px;
            background: #667eea;
            color: white;
            padding: 8px;
            text-decoration: none;
            border-radius: 4px;
            z-index: 10000;
        }
        
        .skip-link:focus {
            top: 6px;
        }
        
        /* å“åº”å¼å¯¼èˆª */
        .navbar {
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        @media (max-width: 991px) {
            .navbar-collapse {
                background: rgba(102, 126, 234, 0.95);
                margin: 1rem -1rem -1rem;
                padding: 1rem;
                border-radius: 0 0 8px 8px;
            }
        }
        
        /* æ— éšœç¢å¢å¼º */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        /* é«˜å¯¹æ¯”åº¦æ¨¡å¼æ”¯æŒ */
        @media (prefers-contrast: high) {
            body {
                background: #000000;
                color: #ffffff;
            }
            
            .card {
                border: 2px solid #ffffff;
                background: #000000;
            }
            
            .btn {
                border: 2px solid #ffffff;
            }
        }
        
        /* å‡å°‘åŠ¨ç”»åå¥½ */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
            }
        }
        
        /* æ‰“å°æ ·å¼ */
        @media print {
            .navbar, .btn, .particles {
                display: none !important;
            }
            
            body {
                background: white !important;
                color: black !important;
            }
        }
        
        /* Emojiå›¾æ ‡æ ·å¼ */
        .emoji-icon {
            font-family: "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji", sans-serif !important;
            font-weight: normal !important;
            font-style: normal !important;
            font-size: 1em !important;
            display: inline-block !important;
            text-decoration: none !important;
            line-height: 1 !important;
            vertical-align: middle;
        }
    </style>
    </style>
    
    {% block extra_head %}{% endblock %}
</head>
<body data-debug="{% if debug %}true{% else %}false{% endif %}" class="icon-fallback-active">
    <!-- æ— éšœç¢è·³è¿‡é“¾æ¥ -->
    <a href="#main-content" class="skip-link">è·³è½¬åˆ°ä¸»è¦å†…å®¹</a>
    
    <!-- èƒŒæ™¯ç²’å­æ•ˆæœ -->
    <div class="particles" id="particles" aria-hidden="true"></div>
    
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar navbar-expand-lg navbar-dark glass-effect" style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.9), rgba(118, 75, 162, 0.9));" role="navigation" aria-label="ä¸»è¦å¯¼èˆª">
        <div class="container">
            <a class="navbar-brand fw-bold" href="{% url 'rcode_helper:home' %}" style="text-shadow: 0 2px 4px rgba(0,0,0,0.3);" aria-label="è¿”å›é¦–é¡µ">
                <span class="emoji-icon me-2" aria-hidden="true">ğŸ“ˆ</span>Rè¯­è¨€æ™ºèƒ½åŠ©æ‰‹
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="åˆ‡æ¢å¯¼èˆªèœå•">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link fw-semibold{% if request.resolver_match.url_name == 'home' %} active{% endif %}" 
                           href="{% url 'rcode_helper:home' %}" 
                           style="text-shadow: 0 1px 2px rgba(0,0,0,0.3);"
                           {% if request.resolver_match.url_name == 'home' %}aria-current="page"{% endif %}>
                            <span class="emoji-icon me-1" aria-hidden="true">ğŸ </span>é¦–é¡µ
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link fw-semibold{% if request.resolver_match.url_name == 'history' %} active{% endif %}" 
                           href="{% url 'rcode_helper:history' %}" 
                           style="text-shadow: 0 1px 2px rgba(0,0,0,0.3);"
                           {% if request.resolver_match.url_name == 'history' %}aria-current="page"{% endif %}>
                            <span class="emoji-icon me-1" aria-hidden="true">ğŸ“‹</span>å†å²è®°å½•
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link fw-semibold{% if request.resolver_match.url_name == 'monitoring_dashboard' %} active{% endif %}" 
                           href="{% url 'rcode_helper:monitoring_dashboard' %}" 
                           style="text-shadow: 0 1px 2px rgba(0,0,0,0.3);"
                           {% if request.resolver_match.url_name == 'monitoring_dashboard' %}aria-current="page"{% endif %}>
                            <span class="emoji-icon me-1" aria-hidden="true">ğŸ“ˆ</span>ç³»ç»Ÿç›‘æ§
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link fw-semibold{% if request.resolver_match.url_name == 'dashboard' %} active{% endif %}" 
                           href="{% url 'rcode_helper:dashboard' %}" 
                           style="text-shadow: 0 1px 2px rgba(0,0,0,0.3);"
                           {% if request.resolver_match.url_name == 'dashboard' %}aria-current="page"{% endif %}>
                            <span class="emoji-icon me-1" aria-hidden="true">ğŸ“Š</span>ä»ªè¡¨æ¿
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link fw-semibold{% if request.resolver_match.url_name == 'test_features' %} active{% endif %}" 
                           href="{% url 'rcode_helper:test_features' %}" 
                           style="text-shadow: 0 1px 2px rgba(0,0,0,0.3);"
                           {% if request.resolver_match.url_name == 'test_features' %}aria-current="page"{% endif %}>
                            <span class="emoji-icon me-1" aria-hidden="true">ğŸ§ª</span>åŠŸèƒ½æµ‹è¯•
                        </a>
                    </li>
                    <!-- ä¸»é¢˜é€‰æ‹©å™¨ -->
                    <li class="nav-item">
                        <div id="navbar-theme-selector"></div>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- å¼ºåˆ¶ Emoji è¦†ç›–è§„åˆ™ï¼ˆå†…è”ä»¥ä¿è¯æœ€é«˜ä¼˜å…ˆçº§ï¼‰ -->
    <style>
    /* éšè— Font Awesome ::before å¹¶ç”¨ ::after æ˜¾ç¤º emoji */
    body.icon-fallback-active i[class*="fa-"]::before,
    body.icon-fallback-active span[class*="fa-"]::before {
        content: none !important;
        display: none !important;
    }
    body.icon-fallback-active i[class*="fa-"]::after,
    body.icon-fallback-active span[class*="fa-"]::after {
        font-family: "Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji",sans-serif !important;
        font-style: normal !important;
        font-weight: normal !important;
        display: inline-block !important;
        line-height: 1 !important;
        text-decoration: none !important;
    }

    /* å¸¸è§å›¾æ ‡æ˜ å°„ */
    body.icon-fallback-active i.fa-home::after { content: "ğŸ " !important; }
    body.icon-fallback-active i.fa-user::after { content: "ğŸ‘¤" !important; }
    body.icon-fallback-active i.fa-cog::after { content: "âš™ï¸" !important; }
    body.icon-fallback-active i.fa-heart::after { content: "â¤ï¸" !important; }
    body.icon-fallback-active i.fa-star::after { content: "â­" !important; }
    body.icon-fallback-active i.fa-search::after { content: "ğŸ”" !important; }
    body.icon-fallback-active i.fa-bell::after { content: "ğŸ””" !important; }
    body.icon-fallback-active i.fa-envelope::after { content: "âœ‰ï¸" !important; }
    body.icon-fallback-active i.fa-chart-line::after { content: "ğŸ“ˆ" !important; }
    body.icon-fallback-active i.fa-smile::after { content: "ğŸ˜Š" !important; }
    body.icon-fallback-active i.fa-exclamation-triangle::after { content: "âš ï¸" !important; }
    body.icon-fallback-active i.fa-history::after { content: "ğŸ•˜" !important; }
    body.icon-fallback-active i.fa-code::after { content: "ğŸ’»" !important; }
    body.icon-fallback-active i.fa-database::after { content: "ğŸ—„ï¸" !important; }
    </style>

    <!-- ä¸»è¦å†…å®¹ -->
    <main id="main-content" class="container mt-4" role="main">
        <!-- æ¶ˆæ¯æç¤º -->
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}

        {% block content %}
        {% endblock %}
    </main>

    <!-- é¡µè„š -->
    <footer class="footer mt-5 py-4" style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1)); backdrop-filter: blur(10px); border-top: 1px solid rgba(255, 255, 255, 0.1);" role="contentinfo">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <p class="mb-0 text-center text-md-start">
                        <span class="emoji-icon text-danger me-2" aria-hidden="true">â¤ï¸</span>
                        Â© 2024 Rè¯­è¨€åŠ©æ‰‹ | åŸºäº DeepSeek Chat API æä¾›æ™ºèƒ½Rè¯­è¨€å­¦ä¹ æœåŠ¡
                        <span class="emoji-icon ms-2" aria-hidden="true">ğŸ’»</span>
                    </p>
                </div>
                <div class="col-md-6">
                    <div class="text-center text-md-end">
                        <small class="text-muted">
                            <span id="current-time"></span> | 
                            <span id="page-load-time"></span>
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </footer>

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    
    <!-- å¢å¼ºUIåŠŸèƒ½ -->
    <script src="{% static 'js/enhanced-ui.js' %}"></script>
    <script src="{% static 'js/interaction-enhancer.js' %}"></script>
    
    <!-- åŸºç¡€åŠŸèƒ½è„šæœ¬ -->
    <script>
        // é¡µé¢åŠ è½½æ—¶é—´ç»Ÿè®¡
        document.addEventListener('DOMContentLoaded', function() {
            const loadTime = performance.now();
            const pageLoadTimeEl = document.getElementById('page-load-time');
            if (pageLoadTimeEl) {
                pageLoadTimeEl.textContent = `é¡µé¢åŠ è½½: ${Math.round(loadTime)}ms`;
            }
            
            // æ›´æ–°æ—¶é—´æ˜¾ç¤º
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            
            // åˆå§‹åŒ–ç²’å­æ•ˆæœ
            if (window.innerWidth > 768) { // ä»…åœ¨æ¡Œé¢è®¾å¤‡ä¸Šæ˜¾ç¤º
                createParticles();
            }
            
            // åˆå§‹åŒ–æ€§èƒ½ç›‘æ§
            if (typeof PerformanceMonitor !== 'undefined') {
                PerformanceMonitor.init();
            }
        });
        
        function updateCurrentTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('zh-CN', { 
                hour12: false,
                hour: '2-digit',
                minute: '2-digit'
            });
            const currentTimeEl = document.getElementById('current-time');
            if (currentTimeEl) {
                currentTimeEl.textContent = timeStr;
            }
        }
        
        // åˆ›å»ºæµ®åŠ¨ç²’å­æ•ˆæœ
        function createParticles() {
            const particlesContainer = document.getElementById('particles');
            if (!particlesContainer) return;
            
            const particleCount = Math.min(30, Math.floor(window.innerWidth / 40));
            
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                
                // éšæœºå¤§å°å’Œä½ç½®
                const size = Math.random() * 4 + 2;
                const x = Math.random() * window.innerWidth;
                const y = Math.random() * window.innerHeight;
                const duration = Math.random() * 20 + 10;
                
                particle.style.cssText = `
                    position: fixed;
                    width: ${size}px;
                    height: ${size}px;
                    background: rgba(255, 255, 255, ${Math.random() * 0.5 + 0.2});
                    border-radius: 50%;
                    left: ${x}px;
                    top: ${y}px;
                    pointer-events: none;
                    z-index: -1;
                    animation: float ${duration}s infinite linear;
                `;
                
                particlesContainer.appendChild(particle);
            }
        }
        
        // é”™è¯¯å¤„ç†
        window.addEventListener('error', function(e) {
            console.error('é¡µé¢é”™è¯¯:', e.error);
            
            // å‘é€é”™è¯¯åˆ°ç›‘æ§ç³»ç»Ÿï¼ˆå¦‚æœæœ‰ï¼‰
            if (typeof PerformanceMonitor !== 'undefined' && PerformanceMonitor.reportError) {
                PerformanceMonitor.reportError(e.error);
            }
        });
        
        // æœªå¤„ç†çš„Promiseé”™è¯¯
        window.addEventListener('unhandledrejection', function(e) {
            console.error('æœªå¤„ç†çš„Promiseé”™è¯¯:', e.reason);
            
            if (typeof PerformanceMonitor !== 'undefined' && PerformanceMonitor.reportError) {
                PerformanceMonitor.reportError(e.reason);
            }
        });
        
        // é¡µé¢å¯è§æ€§å˜åŒ–å¤„ç†
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                // é¡µé¢ä¸å¯è§æ—¶æš‚åœåŠ¨ç”»
                document.body.classList.add('page-hidden');
            } else {
                // é¡µé¢å¯è§æ—¶æ¢å¤åŠ¨ç”»
                document.body.classList.remove('page-hidden');
            }
        });
    </script>
    
    <!-- åŠ¨ç”»æ ·å¼ -->
    <style>
        @keyframes float {
            0% {
                transform: translateY(0px) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(-100vh) rotate(360deg);
                opacity: 0;
            }
        }
        
        .particle {
            will-change: transform, opacity;
        }
        
        /* é¡µé¢éšè—æ—¶åœæ­¢åŠ¨ç”» */
        .page-hidden .particle {
            animation-play-state: paused;
        }
        
        /* å“åº”å¼ç²’å­ */
        @media (max-width: 768px) {
            .particles {
                display: none;
            }
        }
        
        @media (prefers-reduced-motion: reduce) {
            .particle {
                animation: none !important;
            }
        }
    </style>
    
    <!-- æ€§èƒ½ä¼˜åŒ–å™¨ -->
    <script src="{% static 'js/performance-optimizer.js' %}" defer></script>
    
    <!-- ç”¨æˆ·ä½“éªŒå¢å¼ºå™¨ -->
    <script src="{% static 'js/ux-enhancer.js' %}" defer></script>
    
    <!-- ä¸»é¢˜ç®¡ç†å™¨ -->
    <script src="{% static 'js/theme-manager.js' %}" defer></script>
    
    <!-- å›¾æ ‡ç®¡ç†å™¨ -->
    <script src="{% static 'js/icon-manager-final.js' %}" defer></script>
    
    <!-- å…¨å±€è„šæœ¬å’Œé”™è¯¯å¤„ç† -->
    <script>
        // è®¾ç½®è°ƒè¯•æ¨¡å¼ï¼ˆä»body dataå±æ€§è¯»å–ï¼‰
        window.DEBUG_MODE = document.body.dataset.debug === 'true';
        
        // å…¨å±€é”™è¯¯å¤„ç†
        window.addEventListener('error', function(e) {
            console.error('JavaScripté”™è¯¯:', e.error);
            
            // è®°å½•é”™è¯¯åˆ°æ€§èƒ½åˆ†æå™¨
            if (window.uxEnhancer && window.uxEnhancer.analytics) {
                window.uxEnhancer.analytics.errors.push({
                    message: e.message,
                    filename: e.filename,
                    lineno: e.lineno,
                    timestamp: Date.now()
                });
            }
            
            // æ˜¾ç¤ºç”¨æˆ·å‹å¥½çš„é”™è¯¯ä¿¡æ¯
            const errorNotification = document.createElement('div');
            errorNotification.className = 'alert alert-warning alert-dismissible fade show error-notification';
            errorNotification.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; max-width: 400px;';
            errorNotification.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <div>
                        <strong>æ¸©é¦¨æç¤ºï¼š</strong> é¡µé¢é‡åˆ°äº†ä¸€äº›å°é—®é¢˜ï¼Œä½†ä¸å½±å“æ­£å¸¸ä½¿ç”¨ã€‚
                        <br><small class="text-muted">å¦‚æœé—®é¢˜æŒç»­ï¼Œè¯·åˆ·æ–°é¡µé¢æˆ–è”ç³»æ”¯æŒã€‚</small>
                    </div>
                    <button type="button" class="btn-close ms-auto" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            document.body.appendChild(errorNotification);
            
            // 5ç§’åè‡ªåŠ¨æ¶ˆå¤±
            setTimeout(() => {
                if (errorNotification.parentNode) {
                    errorNotification.remove();
                }
            }, 5000);
        });
        
        // Promise é”™è¯¯å¤„ç†
        window.addEventListener('unhandledrejection', function(e) {
            console.error('æœªå¤„ç†çš„Promiseé”™è¯¯:', e.reason);
            
            if (window.uxEnhancer && window.uxEnhancer.analytics) {
                window.uxEnhancer.analytics.errors.push({
                    type: 'unhandledrejection',
                    reason: e.reason,
                    timestamp: Date.now()
                });
            }
        });
        
        // æ€§èƒ½ç›‘æ§
        window.addEventListener('load', function() {
            if (window.performance && window.performance.timing) {
                const timing = window.performance.timing;
                const loadTime = timing.loadEventEnd - timing.navigationStart;
                const dnsTime = timing.domainLookupEnd - timing.domainLookupStart;
                const connectTime = timing.connectEnd - timing.connectStart;
                const renderTime = timing.domComplete - timing.domLoading;
                
                // æ€§èƒ½æŒ‡æ ‡è®°å½•
                const performanceData = {
                    loadTime,
                    dnsTime,
                    connectTime,
                    renderTime,
                    timestamp: Date.now()
                };
                
                console.log('é¡µé¢æ€§èƒ½æŒ‡æ ‡:', performanceData);
                
                // æ€§èƒ½è­¦å‘Š
                if (loadTime > 3000) {
                    console.warn(`é¡µé¢åŠ è½½æ—¶é—´è¾ƒé•¿: ${loadTime}ms`);
                    
                    // æ˜¾ç¤ºæ€§èƒ½æç¤º
                    if (loadTime > 5000) {
                        setTimeout(() => {
                            const performanceHint = document.createElement('div');
                            performanceHint.className = 'alert alert-info alert-dismissible fade show performance-hint';
                            performanceHint.style.cssText = 'position: fixed; bottom: 20px; left: 20px; z-index: 9999; max-width: 350px;';
                            performanceHint.innerHTML = `
                                <div class="d-flex align-items-center">
                                    <span class="emoji-icon me-2">ğŸš€</span>
                                    <div>
                                        <strong>æ€§èƒ½æç¤ºï¼š</strong> ç½‘ç»œè¾ƒæ…¢æ—¶ï¼Œå¯å¯ç”¨æ•°æ®èŠ‚çœæ¨¡å¼è·å¾—æ›´å¥½ä½“éªŒã€‚
                                        <br><button class="btn btn-sm btn-primary mt-1" onclick="if(window.performanceOptimizer) window.performanceOptimizer.enableDataSavingMode(); this.closest('.alert').remove();">å¯ç”¨æ•°æ®èŠ‚çœæ¨¡å¼</button>
                                    </div>
                                    <button type="button" class="btn-close ms-auto" data-bs-dismiss="alert"></button>
                                </div>
                            `;
                            document.body.appendChild(performanceHint);
                            
                            setTimeout(() => {
                                if (performanceHint.parentNode) {
                                    performanceHint.remove();
                                }
                            }, 10000);
                        }, 2000);
                    }
                }
                
                // å­˜å‚¨æ€§èƒ½æ•°æ®
                if (window.performanceOptimizer) {
                    window.performanceOptimizer.cacheInLocalStorage('performance_metrics', performanceData);
                }
            }
        });
        
        // ç½‘ç»œçŠ¶æ€ç›‘æ§
        window.addEventListener('online', function() {
            const notification = document.createElement('div');
            notification.className = 'alert alert-success alert-dismissible fade show network-notification';
            notification.style.cssText = 'position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999;';
            notification.innerHTML = `
                <div class="d-flex align-items-center">
                    <span class="emoji-icon me-2">ğŸ“¶</span>
                    <span>ç½‘ç»œè¿æ¥å·²æ¢å¤</span>
                    <button type="button" class="btn-close ms-auto" data-bs-dismiss="alert"></button>
                </div>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 3000);
        });
        
        window.addEventListener('offline', function() {
            const notification = document.createElement('div');
            notification.className = 'alert alert-warning alert-dismissible fade show network-notification';
            notification.style.cssText = 'position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999;';
            notification.innerHTML = `
                <div class="d-flex align-items-center">
                    <span class="emoji-icon me-2" style="text-decoration: line-through;">ğŸ“¶</span>
                    <span>ç½‘ç»œè¿æ¥å·²æ–­å¼€ï¼Œéƒ¨åˆ†åŠŸèƒ½å¯èƒ½ä¸å¯ç”¨</span>
                    <button type="button" class="btn-close ms-auto" data-bs-dismiss="alert"></button>
                </div>
            `;
            document.body.appendChild(notification);
        });
        
        // åˆå§‹åŒ–å®Œæˆå›è°ƒ
        document.addEventListener('DOMContentLoaded', function() {
            // è®¾ç½®å…¨å±€é…ç½®
            window.R_HELPER_CONFIG = {
                version: '1.0.0',
                features: {
                    advancedEditor: true,
                    performanceOptimization: true,
                    userExperienceEnhancement: true,
                    accessibilitySupport: true
                },
                debug: window.DEBUG_MODE || false
            };
            
            // å»¶è¿ŸåŠ è½½éå…³é”®èµ„æº
            setTimeout(() => {
                // é¢„åŠ è½½ä¸‹ä¸€é¡µå¯èƒ½éœ€è¦çš„èµ„æº
                if (window.performanceOptimizer) {
                    window.performanceOptimizer.preloadIdleResources();
                }
            }, 1000);
        });
        
        // é¡µé¢å¸è½½æ—¶çš„æ¸…ç†
        window.addEventListener('beforeunload', function() {
            // ä¿å­˜ç”¨æˆ·çŠ¶æ€
            if (window.uxEnhancer) {
                window.uxEnhancer.savePreferences();
            }
            
            // æ€§èƒ½æ•°æ®ä¸ŠæŠ¥
            if (window.performanceOptimizer && navigator.sendBeacon) {
                const performanceData = {
                    sessionTime: Date.now() - (window.uxEnhancer?.analytics?.session_start || Date.now()),
                    interactionCount: window.uxEnhancer?.analytics?.interactions || 0,
                    featuresUsed: window.uxEnhancer?.analytics?.features_used?.size || 0,
                    errors: window.uxEnhancer?.analytics?.errors?.length || 0
                };
                
                navigator.sendBeacon('/api/analytics/', JSON.stringify(performanceData));
            }
        });
    </script>
    
    {% block scripts %}{% endblock %}
</body>
</html>