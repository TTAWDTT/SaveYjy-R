/**
 * Performance Optimizer
 * È°µÈù¢ÊÄßËÉΩ‰ºòÂåñÊ®°ÂùóÔºö‰ª£Á†ÅÂàÜÂâ≤„ÄÅÊáíÂä†ËΩΩ„ÄÅÁºìÂ≠òÁ≠ñÁï•Á≠â
 */

class PerformanceOptimizer {
    constructor() {
        this.observers = new Map();
        this.loadedModules = new Set();
        this.imageCache = new Map();
        this.resourceQueue = [];
        this.isOnline = navigator.onLine;
        
        this.init();
    }
    
    init() {
        this.setupIntersectionObserver();
        this.setupResourcePreloading();
        this.setupImageLazyLoading();
        this.setupCodeSplitting();
        this.setupCacheStrategy();
        this.setupNetworkOptimization();
        this.setupPerformanceMonitoring();
        
        console.log('üöÄ ÊÄßËÉΩ‰ºòÂåñÂô®Â∑≤ÂàùÂßãÂåñ');
    }
    
    // ===== ÊáíÂä†ËΩΩ‰ºòÂåñ =====
    setupIntersectionObserver() {
        if (!('IntersectionObserver' in window)) {
            console.warn('IntersectionObserver‰∏çÊîØÊåÅÔºå‰ΩøÁî®ÂõûÈÄÄÊñπÊ°à');
            return;
        }
        
        // ÂõæÁâáÊáíÂä†ËΩΩËßÇÂØüÂô®
        this.observers.set('images', new IntersectionObserver(
            (entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        this.loadImage(entry.target);
                        this.observers.get('images').unobserve(entry.target);
                    }
                });
            },
            { 
                rootMargin: '50px 0px',
                threshold: 0.1
            }
        ));
        
        // ÁªÑ‰ª∂ÊáíÂä†ËΩΩËßÇÂØüÂô®
        this.observers.set('components', new IntersectionObserver(
            (entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        this.loadComponent(entry.target);
                        this.observers.get('components').unobserve(entry.target);
                    }
                });
            },
            { 
                rootMargin: '100px 0px',
                threshold: 0.1
            }
        ));
    }
    
    setupImageLazyLoading() {
        // ‰∏∫ÊâÄÊúâÈúÄË¶ÅÊáíÂä†ËΩΩÁöÑÂõæÁâáËÆæÁΩÆËßÇÂØü
        const lazyImages = document.querySelectorAll('img[data-src], img[loading="lazy"]');
        
        lazyImages.forEach(img => {
            // ËÆæÁΩÆÂç†‰ΩçÁ¨¶
            if (!img.src && !img.dataset.src) return;
            
            if (img.dataset.src && !img.src) {
                img.src = this.generatePlaceholder(img.width || 300, img.height || 200);
            }
            
            this.observers.get('images')?.observe(img);
        });
        
        // Âä®ÊÄÅÊ∑ªÂä†ÁöÑÂõæÁâá‰πüËøõË°åÊáíÂä†ËΩΩ
        const imageObserver = new MutationObserver((mutations) => {
            mutations.forEach(mutation => {
                mutation.addedNodes.forEach(node => {
                    if (node.nodeType === 1) {
                        const images = node.querySelectorAll?.('img[data-src], img[loading="lazy"]') || 
                                     (node.tagName === 'IMG' ? [node] : []);
                        
                        images.forEach(img => {
                            if (img.dataset.src && !img.src) {
                                img.src = this.generatePlaceholder(img.width || 300, img.height || 200);
                            }
                            this.observers.get('images')?.observe(img);
                        });
                    }
                });
            });
        });
        
        imageObserver.observe(document.body, { childList: true, subtree: true });
    }
    
    generatePlaceholder(width, height) {
        const canvas = document.createElement('canvas');
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext('2d');
        
        // Ê∏êÂèòËÉåÊôØ
        const gradient = ctx.createLinearGradient(0, 0, width, height);
        gradient.addColorStop(0, '#f0f0f0');
        gradient.addColorStop(1, '#e0e0e0');
        
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, width, height);
        
        // Ê∑ªÂä†Âä†ËΩΩÂõæÊ†á
        ctx.fillStyle = '#ccc';
        ctx.font = '16px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('Loading...', width / 2, height / 2);
        
        return canvas.toDataURL('image/png');
    }
    
    async loadImage(img) {
        const src = img.dataset.src || img.src;
        if (!src || this.imageCache.has(src)) return;
        
        try {
            // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
            img.classList.add('loading');
            
            // È¢ÑÂä†ËΩΩÂõæÁâá
            const preloadImg = new Image();
            await new Promise((resolve, reject) => {
                preloadImg.onload = resolve;
                preloadImg.onerror = reject;
                preloadImg.src = src;
            });
            
            // ÁºìÂ≠òÂõæÁâá
            this.imageCache.set(src, preloadImg);
            
            // Â∫îÁî®ÂõæÁâá
            img.src = src;
            img.classList.remove('loading');
            img.classList.add('loaded');
            
            // Ê∑ªÂä†Ê∑°ÂÖ•ÊïàÊûú
            this.fadeIn(img);
            
        } catch (error) {
            console.error('ÂõæÁâáÂä†ËΩΩÂ§±Ë¥•:', src, error);
            img.classList.remove('loading');
            img.classList.add('error');
            
            // ËÆæÁΩÆÈîôËØØÂç†‰ΩçÁ¨¶
            img.src = this.generateErrorPlaceholder();
        }
    }
    
    generateErrorPlaceholder() {
        const canvas = document.createElement('canvas');
        canvas.width = 300;
        canvas.height = 200;
        const ctx = canvas.getContext('2d');
        
        ctx.fillStyle = '#ff6b6b';
        ctx.fillRect(0, 0, 300, 200);
        
        ctx.fillStyle = 'white';
        ctx.font = '16px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('Âä†ËΩΩÂ§±Ë¥•', 150, 100);
        
        return canvas.toDataURL('image/png');
    }
    
    fadeIn(element) {
        element.style.opacity = '0';
        element.style.transition = 'opacity 0.3s ease';
        
        requestAnimationFrame(() => {
            element.style.opacity = '1';
        });
    }
    
    // ===== ÁªÑ‰ª∂ÊáíÂä†ËΩΩ =====
    setupCodeSplitting() {
        const lazyComponents = document.querySelectorAll('[data-lazy-component]');
        
        lazyComponents.forEach(element => {
            this.observers.get('components')?.observe(element);
        });
    }
    
    async loadComponent(element) {
        const componentName = element.dataset.lazyComponent;
        if (!componentName || this.loadedModules.has(componentName)) return;
        
        try {
            element.innerHTML = '<div class="component-loading">ÁªÑ‰ª∂Âä†ËΩΩ‰∏≠...</div>';
            
            // Âä®ÊÄÅÂä†ËΩΩÁªÑ‰ª∂
            const module = await this.dynamicImport(componentName);
            
            if (module && module.default) {
                const componentInstance = new module.default(element);
                await componentInstance.render();
                
                this.loadedModules.add(componentName);
                element.classList.add('component-loaded');
            }
            
        } catch (error) {
            console.error(`ÁªÑ‰ª∂Âä†ËΩΩÂ§±Ë¥•: ${componentName}`, error);
            element.innerHTML = '<div class="component-error">ÁªÑ‰ª∂Âä†ËΩΩÂ§±Ë¥•</div>';
        }
    }
    
    async dynamicImport(moduleName) {
        const moduleMap = {
            'chart': () => import('/static/js/components/chart.js'),
            'editor': () => import('/static/js/components/editor.js'),
            'dashboard': () => import('/static/js/components/dashboard.js'),
            'analytics': () => import('/static/js/components/analytics.js')
        };
        
        if (moduleMap[moduleName]) {
            return await moduleMap[moduleName]();
        }
        
        // ÈÄöÁî®Ê®°ÂùóÂä†ËΩΩ
        return await import(`/static/js/components/${moduleName}.js`);
    }
    
    // ===== ËµÑÊ∫êÈ¢ÑÂä†ËΩΩ =====
    setupResourcePreloading() {
        // È¢ÑÂä†ËΩΩÂÖ≥ÈîÆËµÑÊ∫ê
        this.preloadCriticalResources();
        
        // Á©∫Èó≤Êó∂Èó¥È¢ÑÂä†ËΩΩ
        this.setupIdlePreloading();
        
        // È¢ÑÊµãÊÄßÈ¢ÑÂä†ËΩΩ
        this.setupPredictivePreloading();
    }
    
    preloadCriticalResources() {
        const criticalResources = [
            '/static/css/advanced-code-editor.css',
            '/static/js/advanced-code-editor.js',
            'https://cdn.jsdelivr.net/npm/monaco-editor@latest/min/vs/loader.js'
        ];
        
        criticalResources.forEach(url => {
            this.preloadResource(url);
        });
    }
    
    preloadResource(url, type = 'auto') {
        if (this.loadedModules.has(url)) return;
        
        const link = document.createElement('link');
        link.rel = 'preload';
        link.href = url;
        
        if (type === 'auto') {
            if (url.endsWith('.css')) {
                link.as = 'style';
            } else if (url.endsWith('.js')) {
                link.as = 'script';
            } else {
                link.as = 'fetch';
                link.crossOrigin = 'anonymous';
            }
        } else {
            link.as = type;
        }
        
        document.head.appendChild(link);
        this.loadedModules.add(url);
    }
    
    setupIdlePreloading() {
        if ('requestIdleCallback' in window) {
            requestIdleCallback(() => {
                this.preloadIdleResources();
            });
        } else {
            setTimeout(() => {
                this.preloadIdleResources();
            }, 2000);
        }
    }
    
    preloadIdleResources() {
        const idleResources = [
            '/static/js/interaction-enhancer.js',
            '/static/css/themes.css',
            '/static/js/analytics.js'
        ];
        
        idleResources.forEach(url => {
            this.queueResourceLoad(url);
        });
        
        this.processResourceQueue();
    }
    
    setupPredictivePreloading() {
        // ÁõëÂê¨Áî®Êà∑Ë°å‰∏∫ÔºåÈ¢ÑÊµãÈúÄË¶ÅÂä†ËΩΩÁöÑËµÑÊ∫ê
        document.addEventListener('mouseover', (e) => {
            const link = e.target.closest('a[href]');
            if (link && !link.href.startsWith('#') && !link.href.startsWith('javascript:')) {
                this.predictivePreload(link.href);
            }
        });
        
        // ÁõëÂê¨ÊªöÂä®Ë°å‰∏∫
        let scrollTimeout;
        window.addEventListener('scroll', () => {
            clearTimeout(scrollTimeout);
            scrollTimeout = setTimeout(() => {
                this.checkScrollPreloading();
            }, 100);
        });
    }
    
    predictivePreload(url) {
        // ÈÅøÂÖçÈáçÂ§çÈ¢ÑÂä†ËΩΩ
        if (this.loadedModules.has(url)) return;
        
        const link = document.createElement('link');
        link.rel = 'prefetch';
        link.href = url;
        document.head.appendChild(link);
        
        this.loadedModules.add(url);
    }
    
    checkScrollPreloading() {
        const scrollPercentage = (window.scrollY / (document.body.scrollHeight - window.innerHeight)) * 100;
        
        if (scrollPercentage > 80) {
            // Áî®Êà∑Êé•ËøëÈ°µÈù¢Â∫ïÈÉ®ÔºåÈ¢ÑÂä†ËΩΩ‰∏ã‰∏ÄÈ°µÂÜÖÂÆπ
            this.preloadNextPageResources();
        }
    }
    
    preloadNextPageResources() {
        const nextPageLinks = document.querySelectorAll('a[rel="next"], .pagination .next');
        nextPageLinks.forEach(link => {
            if (link.href) {
                this.predictivePreload(link.href);
            }
        });
    }
    
    // ===== ÁºìÂ≠òÁ≠ñÁï• =====
    setupCacheStrategy() {
        // Service Worker ÁºìÂ≠ò
        this.setupServiceWorker();
        
        // ÂÜÖÂ≠òÁºìÂ≠ò
        this.setupMemoryCache();
        
        // LocalStorage ÁºìÂ≠ò
        this.setupLocalStorageCache();
    }
    
    async setupServiceWorker() {
        if ('serviceWorker' in navigator) {
            try {
                const registration = await navigator.serviceWorker.register('/static/js/sw.js');
                console.log('Service Worker Ê≥®ÂÜåÊàêÂäü:', registration);
                
                // ÁõëÂê¨Êõ¥Êñ∞
                registration.addEventListener('updatefound', () => {
                    const newWorker = registration.installing;
                    newWorker.addEventListener('statechange', () => {
                        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                            this.showUpdateNotification();
                        }
                    });
                });
                
            } catch (error) {
                console.error('Service Worker Ê≥®ÂÜåÂ§±Ë¥•:', error);
            }
        }
    }
    
    setupMemoryCache() {
        this.memoryCache = new Map();
        this.memoryCacheSize = 0;
        this.maxMemoryCacheSize = 50 * 1024 * 1024; // 50MB
    }
    
    cacheInMemory(key, data) {
        const size = this.calculateObjectSize(data);
        
        if (size > this.maxMemoryCacheSize) return false;
        
        // Ê∏ÖÁêÜÁ©∫Èó¥
        while (this.memoryCacheSize + size > this.maxMemoryCacheSize) {
            const firstKey = this.memoryCache.keys().next().value;
            if (firstKey) {
                const firstData = this.memoryCache.get(firstKey);
                this.memoryCacheSize -= this.calculateObjectSize(firstData);
                this.memoryCache.delete(firstKey);
            } else {
                break;
            }
        }
        
        this.memoryCache.set(key, data);
        this.memoryCacheSize += size;
        return true;
    }
    
    getFromMemoryCache(key) {
        return this.memoryCache.get(key);
    }
    
    calculateObjectSize(obj) {
        return JSON.stringify(obj).length * 2; // Â§ßËá¥‰º∞ÁÆó
    }
    
    setupLocalStorageCache() {
        this.localStoragePrefix = 'rhelper_cache_';
        this.maxLocalStorageAge = 24 * 60 * 60 * 1000; // 24Â∞èÊó∂
    }
    
    cacheInLocalStorage(key, data, maxAge = this.maxLocalStorageAge) {
        try {
            const cacheItem = {
                data,
                timestamp: Date.now(),
                maxAge
            };
            
            localStorage.setItem(this.localStoragePrefix + key, JSON.stringify(cacheItem));
            return true;
        } catch (error) {
            console.warn('LocalStorage ÁºìÂ≠òÂ§±Ë¥•:', error);
            return false;
        }
    }
    
    getFromLocalStorageCache(key) {
        try {
            const cached = localStorage.getItem(this.localStoragePrefix + key);
            if (!cached) return null;
            
            const cacheItem = JSON.parse(cached);
            const age = Date.now() - cacheItem.timestamp;
            
            if (age > cacheItem.maxAge) {
                localStorage.removeItem(this.localStoragePrefix + key);
                return null;
            }
            
            return cacheItem.data;
        } catch (error) {
            console.warn('LocalStorage ËØªÂèñÂ§±Ë¥•:', error);
            return null;
        }
    }
    
    clearExpiredCache() {
        const keys = Object.keys(localStorage);
        keys.forEach(key => {
            if (key.startsWith(this.localStoragePrefix)) {
                this.getFromLocalStorageCache(key.replace(this.localStoragePrefix, ''));
            }
        });
    }
    
    // ===== ÁΩëÁªú‰ºòÂåñ =====
    setupNetworkOptimization() {
        // ÁõëÂê¨ÁΩëÁªúÁä∂ÊÄÅÂèòÂåñ
        window.addEventListener('online', () => {
            this.isOnline = true;
            this.processOfflineQueue();
        });
        
        window.addEventListener('offline', () => {
            this.isOnline = false;
            this.showOfflineNotification();
        });
        
        // ÁΩëÁªúË¥®ÈáèÊ£ÄÊµã
        this.detectNetworkQuality();
    }
    
    async detectNetworkQuality() {
        if ('connection' in navigator) {
            const connection = navigator.connection;
            
            // Ê†πÊçÆÁΩëÁªúÁ±ªÂûãË∞ÉÊï¥Âä†ËΩΩÁ≠ñÁï•
            if (connection.effectiveType === 'slow-2g' || connection.effectiveType === '2g') {
                this.enableDataSavingMode();
            }
            
            connection.addEventListener('change', () => {
                if (connection.effectiveType === 'slow-2g' || connection.effectiveType === '2g') {
                    this.enableDataSavingMode();
                } else {
                    this.disableDataSavingMode();
                }
            });
        }
    }
    
    enableDataSavingMode() {
        console.log('ÂêØÁî®Êï∞ÊçÆËäÇÁúÅÊ®°Âºè');
        document.body.classList.add('data-saving-mode');
        
        // ÂÅúÊ≠¢Ëá™Âä®Êí≠ÊîæÂ™í‰Ωì
        const media = document.querySelectorAll('video, audio');
        media.forEach(el => {
            el.pause();
            el.preload = 'none';
        });
        
        // Èôç‰ΩéÂõæÁâáË¥®Èáè
        const images = document.querySelectorAll('img');
        images.forEach(img => {
            if (img.src && !img.dataset.originalSrc) {
                img.dataset.originalSrc = img.src;
                img.src = this.generateLowQualityVersion(img.src);
            }
        });
    }
    
    disableDataSavingMode() {
        console.log('Á¶ÅÁî®Êï∞ÊçÆËäÇÁúÅÊ®°Âºè');
        document.body.classList.remove('data-saving-mode');
        
        // ÊÅ¢Â§çÂéüÂßãÂõæÁâá
        const images = document.querySelectorAll('img[data-original-src]');
        images.forEach(img => {
            img.src = img.dataset.originalSrc;
            delete img.dataset.originalSrc;
        });
    }
    
    generateLowQualityVersion(src) {
        // ÁÆÄÂçïÁöÑ‰ΩéË¥®ÈáèÁâàÊú¨ÁîüÊàêÔºàÂÆûÈôÖ‰∏≠ÂèØËÉΩÈúÄË¶ÅÊúçÂä°Âô®Á´ØÊîØÊåÅÔºâ
        return src + (src.includes('?') ? '&' : '?') + 'quality=low';
    }
    
    // ===== ÊÄßËÉΩÁõëÊéß =====
    setupPerformanceMonitoring() {
        // Web Vitals ÁõëÊéß
        this.monitorWebVitals();
        
        // ËµÑÊ∫êÂä†ËΩΩÊó∂Èó¥ÁõëÊéß
        this.monitorResourceLoading();
        
        // Áî®Êà∑‰∫§‰∫íÊÄßËÉΩÁõëÊéß
        this.monitorInteractionPerformance();
    }
    
    monitorWebVitals() {
        // LCP (Largest Contentful Paint)
        new PerformanceObserver((entryList) => {
            const entries = entryList.getEntries();
            const lastEntry = entries[entries.length - 1];
            console.log('LCP:', lastEntry.startTime);
        }).observe({ entryTypes: ['largest-contentful-paint'] });
        
        // FID (First Input Delay)
        new PerformanceObserver((entryList) => {
            const entries = entryList.getEntries();
            entries.forEach(entry => {
                console.log('FID:', entry.processingStart - entry.startTime);
            });
        }).observe({ entryTypes: ['first-input'] });
        
        // CLS (Cumulative Layout Shift)
        new PerformanceObserver((entryList) => {
            let clsValue = 0;
            for (const entry of entryList.getEntries()) {
                if (!entry.hadRecentInput) {
                    clsValue += entry.value;
                }
            }
            console.log('CLS:', clsValue);
        }).observe({ entryTypes: ['layout-shift'] });
    }
    
    monitorResourceLoading() {
        new PerformanceObserver((entryList) => {
            const entries = entryList.getEntries();
            entries.forEach(entry => {
                if (entry.duration > 1000) { // Ë∂ÖËøá1ÁßíÁöÑËµÑÊ∫ê
                    console.warn('ÊÖ¢ËµÑÊ∫ê:', entry.name, entry.duration + 'ms');
                }
            });
        }).observe({ entryTypes: ['resource'] });
    }
    
    monitorInteractionPerformance() {
        const interactionElements = document.querySelectorAll('button, a, input, textarea');
        
        interactionElements.forEach(element => {
            element.addEventListener('click', (e) => {
                const startTime = performance.now();
                
                requestAnimationFrame(() => {
                    const endTime = performance.now();
                    const duration = endTime - startTime;
                    
                    if (duration > 100) { // Ë∂ÖËøá100ms
                        console.warn('ÊÖ¢‰∫§‰∫í:', element, duration + 'ms');
                    }
                });
            });
        });
    }
    
    // ===== ÈòüÂàóÁÆ°ÁêÜ =====
    queueResourceLoad(url, priority = 0) {
        this.resourceQueue.push({ url, priority });
        this.resourceQueue.sort((a, b) => b.priority - a.priority);
    }
    
    async processResourceQueue() {
        const maxConcurrent = this.isOnline ? 6 : 2;
        const processing = [];
        
        while (this.resourceQueue.length > 0 && processing.length < maxConcurrent) {
            const item = this.resourceQueue.shift();
            const promise = this.loadResource(item.url);
            processing.push(promise);
        }
        
        if (processing.length > 0) {
            await Promise.allSettled(processing);
            
            if (this.resourceQueue.length > 0) {
                setTimeout(() => this.processResourceQueue(), 100);
            }
        }
    }
    
    async loadResource(url) {
        try {
            const response = await fetch(url);
            return response;
        } catch (error) {
            console.error('ËµÑÊ∫êÂä†ËΩΩÂ§±Ë¥•:', url, error);
            throw error;
        }
    }
    
    // ===== ÈÄöÁü•ÊñπÊ≥ï =====
    showUpdateNotification() {
        const notification = document.createElement('div');
        notification.className = 'update-notification';
        notification.innerHTML = `
            <div class="update-content">
                <i class="fas fa-download"></i>
                <span>ÂèëÁé∞Êñ∞ÁâàÊú¨ÔºåÁÇπÂáªÊõ¥Êñ∞</span>
                <button onclick="location.reload()">Êõ¥Êñ∞</button>
            </div>
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.remove();
        }, 10000);
    }
    
    showOfflineNotification() {
        const notification = document.createElement('div');
        notification.className = 'offline-notification';
        notification.innerHTML = `
            <div class="offline-content">
                <i class="fas fa-wifi"></i>
                <span>ÁΩëÁªúËøûÊé•Â∑≤Êñ≠ÂºÄÔºåÈÉ®ÂàÜÂäüËÉΩÂèØËÉΩ‰∏çÂèØÁî®</span>
            </div>
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.remove();
        }, 5000);
    }
    
    processOfflineQueue() {
        console.log('ÁΩëÁªúÊÅ¢Â§çÔºåÂ§ÑÁêÜÁ¶ªÁ∫øÈòüÂàó');
        // Â§ÑÁêÜÁ¶ªÁ∫øÊúüÈó¥ÁßØÁ¥ØÁöÑËØ∑Ê±Ç
    }
}

// Ê†∑Âºè
const performanceStyles = `
<style>
/* ÂõæÁâáÂä†ËΩΩÁä∂ÊÄÅ */
img.loading {
    filter: blur(2px);
    opacity: 0.7;
}

img.loaded {
    filter: none;
    opacity: 1;
    transition: filter 0.3s ease, opacity 0.3s ease;
}

img.error {
    filter: grayscale(100%);
    opacity: 0.5;
}

/* ÁªÑ‰ª∂Âä†ËΩΩÁä∂ÊÄÅ */
.component-loading {
    text-align: center;
    padding: 2rem;
    color: #6c757d;
    background: #f8f9fa;
    border-radius: 8px;
    animation: pulse 2s infinite;
}

.component-error {
    text-align: center;
    padding: 2rem;
    color: #dc3545;
    background: #f8d7da;
    border-radius: 8px;
}

.component-loaded {
    animation: fadeIn 0.5s ease;
}

/* Êï∞ÊçÆËäÇÁúÅÊ®°Âºè */
.data-saving-mode .particles {
    display: none;
}

.data-saving-mode .loading-animation {
    animation-duration: 0.01ms !important;
}

/* Êõ¥Êñ∞ÈÄöÁü• */
.update-notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background: #007bff;
    color: white;
    padding: 1rem;
    border-radius: 8px;
    z-index: 9999;
    animation: slideIn 0.3s ease;
}

.update-content {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.update-content button {
    background: white;
    color: #007bff;
    border: none;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    cursor: pointer;
}

/* Á¶ªÁ∫øÈÄöÁü• */
.offline-notification {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: #dc3545;
    color: white;
    padding: 1rem 2rem;
    border-radius: 8px;
    z-index: 9999;
    animation: slideDown 0.3s ease;
}

.offline-content {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

/* Âä®Áîª */
@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

@keyframes slideIn {
    from { transform: translateX(100%); }
    to { transform: translateX(0); }
}

@keyframes slideDown {
    from { transform: translateX(-50%) translateY(-100%); }
    to { transform: translateX(-50%) translateY(0); }
}

/* ÊÄßËÉΩ‰ºòÂåñÁ±ª */
.perf-optimized {
    will-change: transform;
    contain: layout style paint;
}

.perf-heavy-element {
    contain: strict;
}

/* ÂìçÂ∫îÂºè‰ºòÂåñ */
@media (max-width: 768px) {
    .update-notification,
    .offline-notification {
        left: 10px;
        right: 10px;
        transform: none;
    }
}

/* ÂáèÂ∞ëÂä®ÁîªÂÅèÂ•Ω */
@media (prefers-reduced-motion: reduce) {
    .component-loading {
        animation: none;
    }
    
    img.loaded {
        transition: none;
    }
    
    .update-notification,
    .offline-notification {
        animation: none;
    }
}
</style>
`;

// Ê≥®ÂÖ•Ê†∑Âºè
document.head.insertAdjacentHTML('beforeend', performanceStyles);

// Ëá™Âä®ÂàùÂßãÂåñ
document.addEventListener('DOMContentLoaded', () => {
    window.performanceOptimizer = new PerformanceOptimizer();
});

// ÂØºÂá∫
window.PerformanceOptimizer = PerformanceOptimizer;